

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>abipy.htc.input &mdash; abipy 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="abipy 0.1.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../users/index.html">User&#8217;s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Abipy Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">The AbiPy API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devel/index.html">The AbiPy Developers&#8217; Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">abipy</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>abipy.htc.input</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.htc.input</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines objects that faciliate the creation of the </span>
<span class="sd">ABINIT input files. The syntax is similar to the one used </span>
<span class="sd">in ABINIT with small differences. </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">monty.dev</span> <span class="k">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="k">import</span> <span class="n">dict2namedtuple</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">is_string</span><span class="p">,</span> <span class="n">list_strings</span>
<span class="kn">from</span> <span class="nn">monty.os.path</span> <span class="k">import</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">MSONable</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="k">import</span> <span class="n">Energy</span>
<span class="kn">from</span> <span class="nn">pymatgen.serializers.json_coders</span> <span class="k">import</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinit.pseudos</span> <span class="k">import</span> <span class="n">PseudoTable</span><span class="p">,</span> <span class="n">Pseudo</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinit.tasks</span> <span class="k">import</span> <span class="n">TaskManager</span><span class="p">,</span> <span class="n">AbinitTask</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinit.netcdf</span> <span class="k">import</span> <span class="n">NetcdfReader</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinit.abiinspect</span> <span class="k">import</span> <span class="n">yaml_read_irred_perts</span>
<span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="k">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">Has_Structure</span>
<span class="kn">from</span> <span class="nn">.variable</span> <span class="k">import</span> <span class="n">InputVariable</span>
<span class="kn">from</span> <span class="nn">abipy.abio.abivars</span> <span class="k">import</span> <span class="n">is_abivar</span><span class="p">,</span> <span class="n">is_anaddb_var</span>
<span class="kn">from</span> <span class="nn">abipy.abio.abivars_db</span> <span class="k">import</span> <span class="n">get_abinit_variables</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;AbiInput&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LdauParams&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LexxParams&quot;</span><span class="p">,</span>
    <span class="s2">&quot;input_gen&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Variables that must have a unique value throughout all the datasets.</span>
<span class="n">_ABINIT_NO_MULTI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;jdtset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ndtset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ntypat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;znucl&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cpus&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cpum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cpuh&quot;</span><span class="p">,</span>
    <span class="s2">&quot;npsp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timopt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;iatcon&quot;</span><span class="p">,</span>
    <span class="s2">&quot;natcon&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nconeq&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prtxtypat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wtatcon&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">straceback</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns a string with the traceback.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="k">return</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_idt_varname</span><span class="p">(</span><span class="n">varname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the dataset index from the name of the variable.</span>
<span class="sd">    Return the dataset index and the name of the variable with the numeric index removed.</span>
<span class="sd">    dataset index is set to 0 for global variable.</span>

<span class="sd">    &gt;&gt;&gt; assert _idt_varname(&quot;foo&quot;) == (0, &quot;foo&quot;)</span>
<span class="sd">    &gt;&gt;&gt; assert _idt_varname(&quot;foo1&quot;) == (1, &quot;foo&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">varname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span> 
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">varname</span>

    <span class="c1"># Find the index of the dataset.</span>
    <span class="n">idt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">varname</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">idt</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># Strip the numeric index in varname</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">idt</span><span class="p">))),</span> <span class="n">varname</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>


<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="n">MSONable</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for Input objects.</span>

<span class="sd">    An input object must define have a make_input method </span>
<span class="sd">    that returns the string representation used by the client code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deep copy of the input.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the input file to file to `filepath`. Returns a string with the input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
                                                                                      
        <span class="c1"># Write the input file.</span>
        <span class="n">input_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_string</span>

    <span class="c1">#@abc.abstractmethod</span>
    <span class="c1">#def make_input(self):</span>

    <span class="c1">#@abc.abstractproperty</span>
    <span class="c1">#def structure(self):</span>

    <span class="c1">#def set_structure(self, structure):</span>


<span class="k">class</span> <span class="nc">AbinitInputError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base error class for exceptions raised by `AbiInput`&quot;&quot;&quot;</span>

<span class="c1">#from monty.dev import deprecated</span>
<span class="c1">#from abipy.abio.inputs import AbinitInput</span>
<span class="c1">#@deprecated(replacement=AbinitInput,</span>
<span class="c1">#            message=&quot;This class is deprecated and will be removed in abipy0.2.&quot;)</span>
<div class="viewcode-block" id="AbiInput"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput">[docs]</a><span class="k">class</span> <span class="nc">AbiInput</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object represents an ABINIT input file. It supports multi-datasets a</span>
<span class="sd">    and provides an easy-to-use interface for defining the variables of the calculation.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        inp = AbiInput(pseudos=&quot;si.pspnc&quot;, pseudo_dir=&quot;directory_with_pseudos&quot;)</span>
<span class="sd">        inp.set_structure(&quot;si.cif&quot;)</span>
<span class="sd">        inp.set_vars(ecut=10, nband=3)</span>

<span class="sd">        # Print it to get the final input.</span>
<span class="sd">        print(inp)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">AbinitInputError</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">pseudo_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            pseudos: String or list of string with the name of the pseudopotential files.</span>
<span class="sd">            pseudo_dir: Name of the directory where the pseudopotential files are located.</span>
<span class="sd">            structure: file with the structure, :class:`Structure` object or dictionary with ABINIT geo variable</span>
<span class="sd">            ndtset: Number of datasets.</span>
<span class="sd">            comment: Optional string with a comment that will be placed at the beginning of the file.</span>
<span class="sd">            decorators: List of `AbinitInputDecorator` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Dataset[0] contains the global variables common to the different datasets</span>
        <span class="c1"># Dataset[1:ndtset+1] stores the variables specific to the different datasets.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ndtset</span> <span class="o">=</span> <span class="n">ndtset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndtset</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">dt0</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">dt0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dataset</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">dt0</span><span class="o">=</span><span class="n">dt0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ndtset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndtset</span>

        <span class="c1"># Setup of the pseudopotential files.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">PseudoTable</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos</span> <span class="o">=</span> <span class="n">pseudos</span>

        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Pseudo</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos</span> <span class="o">=</span> <span class="n">PseudoTable</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># String(s)</span>
            <span class="n">pseudo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pseudo_dir</span><span class="p">)</span>
            <span class="n">pseudo_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pseudo_dir</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)]</span>

            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudo_paths</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Cannot find the following pseudopotential files:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span> 

            <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos</span> <span class="o">=</span> <span class="n">PseudoTable</span><span class="p">(</span><span class="n">pseudo_paths</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_decorators</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">decorators</span> <span class="k">else</span> <span class="n">decorators</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation i.e. the input file read by Abinit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;### DATASET </span><span class="si">%d</span><span class="s2"> ###&quot;</span> <span class="o">%</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;### GLOBAL VARIABLES ###&quot;</span>

                <span class="n">str_dataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">str_dataset</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">header</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># single datasets ==&gt; don&#39;t append the dataset index to the variables in self[1]</span>
            <span class="c1"># this trick is needed because Abinit complains if ndtset is not specified </span>
            <span class="c1"># and we have variables that end with the dataset index e.g. acell1</span>
            <span class="c1"># We don&#39;t want to specify ndtset here since abinit will start to add DS# to </span>
            <span class="c1"># the input and output files thus complicating the algorithms we have to use</span>
            <span class="c1"># to locate the files.</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Add JSON section with pseudo potentials.</span>
        <span class="n">ppinfo</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">#&lt;JSON&gt;&quot;</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pseudos&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">]}</span>
        <span class="n">ppinfo</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="n">ppinfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;/JSON&gt;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ppinfo</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AbiInput</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__geattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idt</span><span class="p">,</span> <span class="n">varname</span> <span class="o">=</span> <span class="n">_idt_varname</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="n">idt</span><span class="p">][</span><span class="n">varname</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ndtset&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Cannot change read-only variable ndtset&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="c1"># Standard behaviour for &quot;private&quot; variables.</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">AbiInput</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idt</span><span class="p">,</span> <span class="n">varname</span> <span class="o">=</span> <span class="n">_idt_varname</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Global variable.</span>
                <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_var</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span> <span class="o">&gt;=</span> <span class="n">idt</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Invalid dataset index </span><span class="si">%d</span><span class="s2">, ndtset </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">))</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_var</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

                <span class="c1"># Handle no_multi variables.</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">_ABINIT_NO_MULTI</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">glob_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">varname</span><span class="p">])</span>
                        <span class="n">isok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">glob_value</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isok</span><span class="p">:</span>
                            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;NO_MULTI variable: dataset 0: </span><span class="si">%s</span><span class="s2">, dataset </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">glob_value</span><span class="p">),</span> <span class="n">idt</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_var</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndtset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of datasets.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ndtset&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pseudos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of :class:`Pseudo` objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ispaw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if PAW calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ispaw</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isnc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if norm-conserving calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">isnc</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_valence_electrons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of valence electrons computed from the pseudos and the structure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">num_valence_electrons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the :class:`Structure` associated to the ABINIT input.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError if we have multi datasets with different </span>
<span class="sd">            structure so that users will learn that multiple datasets are bad.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">structure</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot extract a unique structure from an input file with multiple datasets!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> 
                         <span class="s2">&quot;Please DON&#39;T use multiple datasets with different unit cells!&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AbiInput.is_abivar"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.is_abivar">[docs]</a>    <span class="k">def</span> <span class="nf">is_abivar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if varname is a valid Abinit variable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">is_abivar</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.new_with_vars"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.new_with_vars">[docs]</a>    <span class="k">def</span> <span class="nf">new_with_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a new input (deep copy) with these variables&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decorators</span>

<div class="viewcode-block" id="AbiInput.register_decorator"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.register_decorator">[docs]</a>    <span class="k">def</span> <span class="nf">register_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decorator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a :class:`AbinitInputDecorator`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decorators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decorator</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span></div>

<div class="viewcode-block" id="AbiInput.generate"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.generate">[docs]</a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate new inputs by replacing the variables specified in kwargs.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # To generate two input files with different values of ecut:</span>
<span class="sd">            for inp_ecut in gs_inp.generate(ecut=[10, 20])):</span>
<span class="sd">                print(&quot;do something with inp_ecut %s&quot; % inp_ecut)</span>

<span class="sd">            # To generate four input files with all the possible combinations of ecut and nsppol:</span>
<span class="sd">            for inp_ecut in gs_inp.generate(ecut=[10, 20], nsppol=[1, 2]):</span>
<span class="sd">                print(&quot;do something with inp_ecut %s&quot; % inp_ecut)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot use generate methods when ndtset != 1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">input_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_dtset2range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to convert dtset into a range. Accepts int, slice objects or iterable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtset</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">dtset</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtset</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span> 
            <span class="n">start</span> <span class="o">=</span> <span class="n">dtset</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">dtset</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">dtset</span><span class="o">.</span><span class="n">stop</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">dtset</span><span class="o">.</span><span class="n">step</span> <span class="k">if</span> <span class="n">dtset</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtset</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dtset</span>

        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to convert </span><span class="si">%s</span><span class="s2"> to a range-like object&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dtset</span><span class="p">))</span>

<div class="viewcode-block" id="AbiInput.split_datasets"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.split_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">split_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split an input file with multiple datasets into a  list of `ndtset` distinct input files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">news</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">):</span>
            <span class="n">my_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">allvars</span>
            <span class="n">my_vars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ndtset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Cannot use get*, ird* variables since links must be explicit.</span>
            <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">my_vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ird&quot;</span><span class="p">):</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;get* or ird variables should not be present in the input when you split it into datasets&quot;</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">pseudos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_decorators</span><span class="p">)</span>
            <span class="n">new</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="n">my_vars</span><span class="p">)</span>
            <span class="n">new</span><span class="o">.</span><span class="n">set_mnemonics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mnemonics</span><span class="p">)</span>
            <span class="n">news</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">news</span></div>

<div class="viewcode-block" id="AbiInput.set_vars"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_vars">[docs]</a>    <span class="k">def</span> <span class="nf">set_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value of a set of input variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            dtset: Int with the index of the dataset, slice object of iterable </span>
<span class="sd">            kwargs: Dictionary with the variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dtset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dtset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># Alias</span>
    <span class="n">set_variables</span> <span class="o">=</span> <span class="n">set_vars</span>
    <span class="n">set_variables</span> <span class="o">=</span> <span class="n">deprecated</span><span class="p">(</span><span class="n">replacement</span><span class="o">=</span><span class="n">set_vars</span><span class="p">)(</span><span class="n">set_variables</span><span class="p">)</span>

<div class="viewcode-block" id="AbiInput.remove_vars"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.remove_vars">[docs]</a>    <span class="k">def</span> <span class="nf">remove_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the variables listed in keys</span>
<span class="sd">                                                                             </span>
<span class="sd">        Args:</span>
<span class="sd">            dtset: Int with the index of the dataset, slice object of iterable </span>
<span class="sd">            keys: List of variables to remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">remove_vars</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span></div>

    <span class="c1"># Alias</span>
    <span class="n">remove_variables</span> <span class="o">=</span> <span class="n">remove_vars</span>
    <span class="n">remove_variables</span> <span class="o">=</span> <span class="n">deprecated</span><span class="p">(</span><span class="n">replacement</span><span class="o">=</span><span class="n">remove_vars</span><span class="p">)(</span><span class="n">remove_variables</span><span class="p">)</span>

<div class="viewcode-block" id="AbiInput.set_comment"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_comment">[docs]</a>    <span class="k">def</span> <span class="nf">set_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the main comment in the input file.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.set_mnemonics"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_mnemonics">[docs]</a>    <span class="k">def</span> <span class="nf">set_mnemonics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if mnemonics should be printed&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mnemonics</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">boolean</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_mnemonics</span><span class="p">(</span><span class="n">boolean</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mnemonics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if mnemonics should be printed&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mnemonics</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
<div class="viewcode-block" id="AbiInput.get_ibz"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.get_ibz">[docs]</a>    <span class="k">def</span> <span class="nf">get_ibz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngkpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shiftk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function, computes the list of points in the IBZ and the corresponding weights.</span>
<span class="sd">        It should be called with an input file that contains all the mandatory variables required by ABINIT.</span>

<span class="sd">        Args:</span>
<span class="sd">            ngkpt: Number of divisions for the k-mesh (default None i.e. use ngkpt from self)</span>
<span class="sd">            shiftk: Shiftks (default None i.e. use shiftk from self)</span>
<span class="sd">            qpoint: qpoint in reduced coordinates. Used to shift the k-mesh (default None i.e no shift)</span>
<span class="sd">            workdir: Working directory of the fake task used to compute the ibz. Use None for temporary dir.</span>
<span class="sd">            manager: :class:`TaskManager` of the task. If None, the manager is initialized from the config file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `namedtuple` with attributes:</span>
<span class="sd">                points: `ndarray` with points in the IBZ in reduced coordinates.</span>
<span class="sd">                weights: `ndarray` with weights of the points.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Multiple datasets are ignored. Only the list of k-points for dataset 1 are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;get_ibz cannot be used if the input contains more than one dataset&quot;</span><span class="p">)</span>

        <span class="c1"># Avoid modifications in self.</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_datasets</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c1"># The magic value that makes ABINIT print the ibz and then stop.</span>
        <span class="n">inp</span><span class="o">.</span><span class="n">prtkpt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

        <span class="k">if</span> <span class="n">ngkpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">inp</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="n">ngkpt</span>
        <span class="k">if</span> <span class="n">shiftk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">shiftk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shiftk</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">nshiftk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">shiftk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kptopt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">kptopt</span> <span class="o">=</span> <span class="n">kptopt</span>

        <span class="k">if</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">qptn</span><span class="p">,</span> <span class="n">inp</span><span class="o">.</span><span class="n">nqpt</span> <span class="o">=</span> <span class="n">qpoint</span><span class="p">,</span> <span class="mi">1</span>

        <span class="c1"># Build a Task to run Abinit in a shell subprocess</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">AbinitTask</span><span class="o">.</span><span class="n">temp_shell_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start_and_wait</span><span class="p">(</span><span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Read the list of k-points from the netcdf file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">NetcdfReader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;kpts.nc&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">ibz</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;ibz&quot;</span><span class="p">,</span> <span class="s2">&quot;points weights&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ibz</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;reduced_coordinates_of_kpoints&quot;</span><span class="p">),</span>
                           <span class="n">weights</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;kpoint_weights&quot;</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># Try to understand if it&#39;s a problem with the Abinit input.</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exc</span></div>

<div class="viewcode-block" id="AbiInput.get_irred_perts"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.get_irred_perts">[docs]</a>    <span class="k">def</span> <span class="nf">get_irred_perts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngkpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shiftk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function, computes the list of irreducible perturbations for DFPT.</span>
<span class="sd">        It should be called with an input file that contains all the mandatory variables required by ABINIT.</span>

<span class="sd">        Args:</span>
<span class="sd">            ngkpt: Number of divisions for the k-mesh (default None i.e. use ngkpt from self)</span>
<span class="sd">            shiftk: Shiftks (default None i.e. use shiftk from self)</span>
<span class="sd">            qpoint: qpoint in reduced coordinates. Used to shift the k-mesh (default None i.e no shift)</span>
<span class="sd">            workdir: Working directory of the fake task used to compute the ibz. Use None for temporary dir.</span>
<span class="sd">            manager: :class:`TaskManager` of the task. If None, the manager is initialized from the config file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dictionaries with the Abinit variables defining the irreducible perturbation</span>
<span class="sd">            Example:</span>

<span class="sd">                [{&#39;idir&#39;: 1, &#39;ipert&#39;: 1, &#39;qpt&#39;: [0.25, 0.0, 0.0]},</span>
<span class="sd">                 {&#39;idir&#39;: 2, &#39;ipert&#39;: 1, &#39;qpt&#39;: [0.25, 0.0, 0.0]}]</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Multiple datasets are ignored. Only the list of k-points for dataset 1 are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;get_irred_perts cannot be used if the input contains more than one dataset&quot;</span><span class="p">)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;get_irred_perts is still under development.&quot;</span><span class="p">)</span>
        <span class="c1"># Avoid modifications in self.</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_datasets</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c1"># Use the magic value paral_rf = -1 to get the list of irreducible perturbations for this q-point.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">paral_rf</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">rfatpol</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">structure</span><span class="p">)],</span>  <span class="c1"># Set of atoms to displace.</span>
            <span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>                  <span class="c1"># Along this set of reduced coordinate axis.</span>
        <span class="p">)</span>
        <span class="n">inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c1"># Build a Task to run Abinit in a shell subprocess</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">AbinitTask</span><span class="o">.</span><span class="n">temp_shell_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start_and_wait</span><span class="p">(</span><span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Parse the file to get the perturbations.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yaml_read_irred_perts</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># Try to understand if it&#39;s a problem with the Abinit input.</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exc</span></div>

<div class="viewcode-block" id="AbiInput.linspace"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.linspace">[docs]</a>    <span class="k">def</span> <span class="nf">linspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns `ndtset` evenly spaced samples, calculated over the interval [`start`, `stop`].</span>

<span class="sd">        The endpoint of the interval can optionally be excluded.</span>

<span class="sd">        Args:</span>
<span class="sd">            start: The starting value of the sequence.</span>
<span class="sd">            stop: The end value of the sequence, unless `endpoint` is set to False.</span>
<span class="sd">                In that case, the sequence consists of all but the last of ``ndtset + 1``</span>
<span class="sd">                evenly spaced samples, so that `stop` is excluded.  Note that the step</span>
<span class="sd">                size changes when `endpoint` is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;varname </span><span class="si">%s</span><span class="s2"> is already defined in globals&quot;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>
            
        <span class="n">lspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">lspace</span><span class="p">):</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">set_var</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.arange"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.arange">[docs]</a>    <span class="k">def</span> <span class="nf">arange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return evenly spaced values within a given interval.</span>

<span class="sd">        Values are generated within the half-open interval ``[start, stop)``</span>
<span class="sd">        (in other words, the interval including `start` but excluding `stop`).</span>

<span class="sd">        When using a non-integer step, such as 0.1, the results will often not</span>
<span class="sd">        be consistent.  It is better to use ``linspace`` for these cases.</span>

<span class="sd">        Args:</span>
<span class="sd">            start:  Start of interval. The interval includes this value. The default start value is 0.</span>
<span class="sd">            stop: End of interval.  The interval does not include this value, except</span>
<span class="sd">                in some cases where `step` is not an integer and floating point</span>
<span class="sd">            step: Spacing between values.  For any output `out`, this is the distance</span>
<span class="sd">                between two adjacent values, ``out[i+1] - out[i]``.  The default</span>
<span class="sd">                step size is 1.  If `step` is specified, `start` must also be given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;varname </span><span class="si">%s</span><span class="s2"> is already defined in globals&quot;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>

        <span class="n">arang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arang</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;len(arang) </span><span class="si">%d</span><span class="s2"> != ndtset </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arang</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">))</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">arang</span><span class="p">):</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">set_var</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.product"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.product">[docs]</a>    <span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cartesian product of input iterables. Equivalent to nested for-loops.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            inp.product(&quot;tsmear&quot;, &quot;ngkpt&quot;, [[2,2,2], [4,4,4]], [0.1, 0.2, 0.3])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Split items into varnames and values</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_string</span><span class="p">(</span><span class="n">item</span><span class="p">):</span> <span class="k">break</span>

        <span class="n">varnames</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">items</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;The number of variables must equal the number of lists&quot;</span><span class="p">)</span>

        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))]</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">varnames</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>

        <span class="n">idt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">varnames</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">idt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)})</span>
        
        <span class="k">if</span> <span class="n">idt</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;The number of configurations must equal ndtset while </span><span class="si">%d</span><span class="s2"> != </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbiInput.set_structure"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_structure">[docs]</a>    <span class="k">def</span> <span class="nf">set_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the :class:`Structure` object for the specified dtset.&quot;&quot;&quot;</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtset</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">set_structure</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_structure_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">Structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the :class:`Structure` object for the specified dtset. </span>
<span class="sd">        data is read from filepath. cls specifies the class to instantiate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="n">dtset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">structure</span>

<div class="viewcode-block" id="AbiInput.set_kmesh"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_kmesh">[docs]</a>    <span class="k">def</span> <span class="nf">set_kmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the variables defining the k-point sampling for the specified dtset.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_kmesh</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="n">kptopt</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.set_autokmesh"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_autokmesh">[docs]</a>    <span class="k">def</span> <span class="nf">set_autokmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nksmall</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the variables (ngkpt, shift, kptopt) for the sampling of the BZ.</span>
<span class="sd">                                                       </span>
<span class="sd">        Args:</span>
<span class="sd">            nksmall: Number of k-points used to sample the smallest lattice vector.</span>
<span class="sd">            kptopt: Option for the generation of the mesh (ABINIT variable).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_autokmesh</span><span class="p">(</span><span class="n">nksmall</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="n">kptopt</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.set_autokpath"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_autokpath">[docs]</a>    <span class="k">def</span> <span class="nf">set_autokpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndivsm</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set automatically the k-path from the lattice </span>
<span class="sd">        and the number of divisions for the smallest segment (ndivsm)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_kpath</span><span class="p">(</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">kptbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.set_kpath"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_kpath">[docs]</a>    <span class="k">def</span> <span class="nf">set_kpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndivsm</span><span class="p">,</span> <span class="n">kptbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the variables defining the k-path for the specified dtset.</span>
<span class="sd">        The list of K-points is taken from the pymatgen database if `kptbounds` is None.</span>

<span class="sd">        Args:</span>
<span class="sd">            ndivsm: Number of divisions for the smallest segment.</span>
<span class="sd">            kptbounds: k-points defining the path in k-space.</span>
<span class="sd">            iscf: iscf variable.</span>
<span class="sd">            dtset: Index of the dataset. 0 for global variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_kpath</span><span class="p">(</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">kptbounds</span><span class="o">=</span><span class="n">kptbounds</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=</span><span class="n">iscf</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiInput.set_kptgw"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.set_kptgw">[docs]</a>    <span class="k">def</span> <span class="nf">set_kptgw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kptgw</span><span class="p">,</span> <span class="n">bdgw</span><span class="p">,</span> <span class="n">dtset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the variables defining the k point for the GW corrections&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtset2range</span><span class="p">(</span><span class="n">dtset</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idt</span><span class="p">]</span><span class="o">.</span><span class="n">set_kptgw</span><span class="p">(</span><span class="n">kptgw</span><span class="p">,</span> <span class="n">bdgw</span><span class="p">)</span></div>

    <span class="nd">@pmg_serialize</span>
<div class="viewcode-block" id="AbiInput.as_dict"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dtsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">ds_copy</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ds_copy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">ds_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">dtsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">ds_copy</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pseudos&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">],</span> 
                <span class="s1">&#39;datasets&#39;</span><span class="p">:</span> <span class="n">dtsets</span><span class="p">,</span>
                <span class="s2">&quot;decorators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">dec</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">dec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decorators</span><span class="p">],</span>
                <span class="p">}</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbiInput.from_dict"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pseudos&#39;</span><span class="p">]:</span>
            <span class="n">pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pseudo</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">]))</span>

        <span class="n">dtsets</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span>
        <span class="n">abiinput</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="n">dtsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ndtset&#39;</span><span class="p">],</span> <span class="n">decorators</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;decorators&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dtsets</span><span class="p">):</span>
            <span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">dtset</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">abiinput</span></div>

<div class="viewcode-block" id="AbiInput.new_from_decorators"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.new_from_decorators">[docs]</a>    <span class="k">def</span> <span class="nf">new_from_decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decorators</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function receives a list of :class:`AbinitInputDecorator` objects or just a single object,</span>
<span class="sd">        applyes the decorators to the input and returns a new :class:`AbiInput` object.</span>
<span class="sd">        self is not changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decorators</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">decorators</span><span class="p">]</span>

        <span class="c1"># Deepcopy only at the first step to improve performance.</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">decorators</span><span class="p">):</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">dec</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">deepcopy</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">inp</span></div>

<div class="viewcode-block" id="AbiInput.validate"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.AbiInput.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run ABINIT in dry mode to validate the input file.</span>

<span class="sd">        Return:</span>
<span class="sd">            `namedtuple` with the following attributes:</span>

<span class="sd">                retcode: Return code. 0 if OK.</span>
<span class="sd">                log_file:  log file of the Abinit run, use log_file.read() to access its content.</span>
<span class="sd">                stderr_file: stderr file of the Abinit run. use stderr_file.read() to access its content.</span>

<span class="sd">        Raises:</span>
<span class="sd">            `RuntimeError` if executable is not in $PATH.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">AbinitTask</span><span class="o">.</span><span class="n">temp_shell_task</span><span class="p">(</span><span class="n">inp</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span> 
        <span class="n">retcode</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">start_and_wait</span><span class="p">(</span><span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exec_args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--dry-run&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">retcode</span><span class="o">=</span><span class="n">retcode</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="n">stderr_file</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">stderr_file</span><span class="p">)</span></div></div>



<span class="k">class</span> <span class="nc">MappingMixin</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixin class implementing the mapping protocol. Useful to avoid boilerplate code if you want</span>
<span class="sd">    to define a object that behaves as a Mapping but without inheriting from dict or similar classes</span>
<span class="sd">    because you don&#39;t want to expose/support all the methods of dict.</span>

<span class="sd">    Client code must initialize a Mapping object either in new or in init and bound it to _mapping_mixin_</span>
<span class="sd">    The implemention of the Mapping interface is delegated to _mapping_mixin_</span>

<span class="sd">    .. Example:</span>

<span class="sd">    &gt;&gt;&gt; class Foo(MappingMixin):</span>
<span class="sd">    ...     def __init__(self, attr, **kwargs):</span>
<span class="sd">    ...         self._mapping_mixin_ = kwargs</span>
<span class="sd">    ...         self.attr = attr</span>
<span class="sd">    &gt;&gt;&gt; obj = Foo(attr=1, spam=2)</span>
<span class="sd">    &gt;&gt;&gt; obj.attr, obj[&quot;spam&quot;]</span>
<span class="sd">    (1, 2)</span>
<span class="sd">    &gt;&gt;&gt; obj.pop(&quot;spam&quot;)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; len(obj), &quot;spam&quot; in obj</span>
<span class="sd">    (0, False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        D.pop(k[,d]) -&gt; v, remove specified key and return the corresponding value.</span>
<span class="sd">        If key is not found, d is returned if given, otherwise KeyError is raised</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        D.update([E, ]**F) -&gt; None.  Update D from dict/iterable E and F.</span>
<span class="sd">        If E present and has a .keys() method, does:     for k in E: D[k] = E[k]</span>
<span class="sd">        If E present and lacks .keys() method, does:     for (k, v) in E: D[k] = v</span>
<span class="sd">        In either case, this is followed by: for k in F: D[k] = F[k]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">f</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">MappingMixin</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the ABINIT variables for a single dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO this should be the &quot;actual&quot; input file</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">AbinitInputError</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">dt0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt0</span> <span class="o">=</span> <span class="n">dt0</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping_mixin_</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The index of the dataset within the input.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dt0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy of the dictionary with the global variables.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt0</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionay with the variables of the dataset + the global variables.</span>
<span class="sd">        Variables local to the dataset overwrite the global values (if any).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_vars</span>
        <span class="n">all_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deepcopy of the `Dataset`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1">#@abc.property</span>
    <span class="c1">#def runlevel(self):</span>
    <span class="c1">#    &quot;&quot;&quot;String defining the Runlevel. See _runl2optdriver.&quot;&quot;&quot;</span>
    <span class="c1"># Mapping runlevel --&gt; optdriver variable</span>
    <span class="c1">#_runl2optdriver = {</span>
    <span class="c1">#    &quot;scf&quot;: 0,</span>
    <span class="c1">#    &quot;nscf&quot;: 0,</span>
    <span class="c1">#    &quot;relax&quot;: 0,</span>
    <span class="c1">#    &quot;dfpt&quot;: 1,</span>
    <span class="c1">#    &quot;screening&quot;: 3,</span>
    <span class="c1">#    &quot;sigma&quot;: 4,</span>
    <span class="c1">#    &quot;bse&quot;: 99,</span>
    <span class="c1">#}</span>
    <span class="c1">#    # Find the value of optdriver (firt in self, then in globals finally use default value.</span>
    <span class="c1">#    optdriver = self.get(&quot;optdriver&quot;)</span>
    <span class="c1">#    if optdriver is None: optdriver = self.dt0.get(&quot;optdriver&quot;)</span>
    <span class="c1">#    if optdriver is None: optdriver = 0</span>

    <span class="c1">#    # At this point we have to understand the type of calculation.</span>

    <span class="k">def</span> <span class="nf">set_mnemonics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if mnemonics should be printed&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mnemonics</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">boolean</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mnemonics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if mnemonics should be printed&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mnemonics</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation.</span>

<span class="sd">        Args:</span>
<span class="sd">            sortmode: &quot;a&quot; for alphabetical order, None if no sorting is wanted</span>
<span class="sd">            post: String that will be appended to the name of the variables</span>
<span class="sd">                Note that post is usually autodetected when we have multiple datatasets</span>
<span class="sd">                It is mainly used when we have an input file with a single dataset</span>
<span class="sd">                so that we can prevent the code from adding &quot;1&quot; to the name of the variables </span>
<span class="sd">                (In this case, indeed, Abinit complains if ndtset=1 is not specified </span>
<span class="sd">                and we don&#39;t want ndtset=1 simply because the code will start to add </span>
<span class="sd">                _DS1_ to all the input and output files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">post</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">post</span>

        <span class="k">if</span> <span class="n">sortmode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># no sorting.</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sortmode</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="c1"># alphabetical order.</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported value for sortmode </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sortmode</span><span class="p">))</span>

        <span class="n">with_mnemonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mnemonics</span>
        <span class="k">if</span> <span class="n">with_mnemonics</span><span class="p">:</span>
            <span class="n">var_database</span> <span class="o">=</span> <span class="n">get_abinit_variables</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="c1"># Do not print NO_MULTI variables except for dataset 0.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">_ABINIT_NO_MULTI</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Print ndtset only if we really have datasets. </span>
            <span class="c1"># This trick prevents abinit from adding DS# to the output files.</span>
            <span class="c1"># thus complicating the creation of workflows made of separated calculations.</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;ndtset&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">with_mnemonics</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">var_database</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;# &lt;&quot;</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">definition</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>

            <span class="n">varname</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="n">post</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">InputVariable</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a comment to be included at the top of the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">comment</span>

    <span class="k">def</span> <span class="nf">set_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a the value of a variable.&quot;&quot;&quot;</span>
        <span class="c1"># Check if varname is in the internal database.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_abivar</span><span class="p">(</span><span class="n">varname</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;varname </span><span class="si">%s</span><span class="s2"> is not a valid ABINIT variable</span><span class="se">\n</span><span class="s2">.&quot;</span>
                             <span class="s2">&quot;Modify abipy/htc/abinit_vars.json&quot;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>

        <span class="c1"># Debugging section.</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">iseq</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">iseq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">iseq</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># array like.</span>
                <span class="n">iseq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">varname</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">iseq</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">iseq</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is already defined with a different value:</span><span class="se">\n</span><span class="s2">OLD:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">NEW</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">varname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">varname</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Handle no_multi variables.</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">_ABINIT_NO_MULTI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                                                                                                      
            <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt0</span><span class="p">:</span>
                <span class="n">glob_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt0</span><span class="p">[</span><span class="n">varname</span><span class="p">])</span>
                <span class="n">isok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">glob_value</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isok</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;NO_MULTI variable: dataset 0: </span><span class="si">%s</span><span class="s2">, dataset </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">glob_value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt0</span><span class="o">.</span><span class="n">set_var</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># Alias</span>
    <span class="n">set_variable</span> <span class="o">=</span> <span class="n">set_var</span>
    <span class="n">set_variable</span> <span class="o">=</span> <span class="n">deprecated</span><span class="p">(</span><span class="n">replacement</span><span class="o">=</span><span class="n">set_var</span><span class="p">)(</span><span class="n">set_variable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the value of the variables provied in the dictionary **kwargs&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">varvalue</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_var</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">varvalue</span><span class="p">)</span>

    <span class="c1"># Alias</span>
    <span class="n">set_variables</span> <span class="o">=</span> <span class="n">set_vars</span>
    <span class="n">set_variables</span> <span class="o">=</span> <span class="n">deprecated</span><span class="p">(</span><span class="n">replacement</span><span class="o">=</span><span class="n">set_vars</span><span class="p">)(</span><span class="n">set_variables</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the variables listed in keys.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;key: </span><span class="si">%s</span><span class="s2"> not in self:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># Alias</span>
    <span class="n">remove_variables</span> <span class="o">=</span> <span class="n">remove_vars</span>
    <span class="n">remove_variables</span> <span class="o">=</span> <span class="n">deprecated</span><span class="p">(</span><span class="n">replacement</span><span class="o">=</span><span class="n">remove_vars</span><span class="p">)(</span><span class="n">remove_variables</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the :class:`Structure` associated to this dataset.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Avoid calling Structure.from_abivars, find a way to cache the object and invalidate it.</span>
        <span class="k">return</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_abivars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvars</span><span class="p">)</span>
        <span class="c1"># Cannot use lazy properties here because we may want to change the structure</span>

        <span class="c1">#if hasattr(self, &quot;_structure&quot;) and self._structure is None:</span>
        <span class="c1">#    return self._structure</span>
        <span class="c1">#try:</span>
        <span class="c1">#    return self._structure</span>
        <span class="c1">#except AttributeError:</span>
        <span class="c1">#    structure = Structure.from_abivars(self.allvars)</span>
        <span class="c1">#    self.set_structure(structure)</span>
        <span class="c1">#    return self._structure</span>

    <span class="k">def</span> <span class="nf">set_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="n">structure</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>

    <span class="c1"># Helper functions to facilitate the specification of several variables.</span>
    <span class="k">def</span> <span class="nf">set_kmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the variables for the sampling of the BZ.</span>

<span class="sd">        Args:</span>
<span class="sd">            ngkpt: Monkhorst-Pack divisions</span>
<span class="sd">            shiftk: List of shifts.</span>
<span class="sd">            kptopt: Option for the generation of the mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shiftk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shiftk</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ngkpt</span><span class="o">=</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="n">kptopt</span><span class="p">,</span> <span class="n">nshiftk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">shiftk</span><span class="p">),</span> <span class="n">shiftk</span><span class="o">=</span><span class="n">shiftk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_autokmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nksmall</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the variables (ngkpt, shift, kptopt) for the sampling of the BZ.</span>
<span class="sd">                                                       </span>
<span class="sd">        Args:</span>
<span class="sd">            nksmall: Number of k-points used to sample the smallest lattice vector.</span>
<span class="sd">            kptopt: Option for the generation of the mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shiftk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">calc_shiftk</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ngkpt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">calc_ngkpt</span><span class="p">(</span><span class="n">nksmall</span><span class="p">),</span> <span class="n">kptopt</span><span class="o">=</span><span class="n">kptopt</span><span class="p">,</span> 
                      <span class="n">nshiftk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">shiftk</span><span class="p">),</span> <span class="n">shiftk</span><span class="o">=</span><span class="n">shiftk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_kpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndivsm</span><span class="p">,</span> <span class="n">kptbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=-</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the variables for the computation of the band structure.</span>

<span class="sd">        Args:</span>
<span class="sd">            ndivsm: Number of divisions for the smallest segment.</span>
<span class="sd">            kptbounds: k-points defining the path in k-space.</span>
<span class="sd">                If None, we use the default high-symmetry k-path defined in the pymatgen database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kptbounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">kptbounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">calc_kptbounds</span><span class="p">()</span>
        <span class="n">kptbounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kptbounds</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">kptbounds</span><span class="o">=</span><span class="n">kptbounds</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kptbounds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">ndivsm</span><span class="o">=</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=</span><span class="n">iscf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_kptgw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kptgw</span><span class="p">,</span> <span class="n">bdgw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the variables (k-points, bands) for the computation of the GW corrections.</span>

<span class="sd">        Args</span>
<span class="sd">            kptgw: List of k-points in reduced coordinates.</span>
<span class="sd">            bdgw: Specifies the range of bands for the GW corrections.</span>
<span class="sd">                Accepts iterable that be reshaped to (nkptgw, 2) </span>
<span class="sd">                or a tuple of two integers if the extrema are the same for each k-point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kptgw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kptgw</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">nkptgw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kptgw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bdgw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">bdgw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kptgw</span><span class="p">)</span> <span class="o">*</span> <span class="n">bdgw</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">kptgw</span><span class="o">=</span><span class="n">kptgw</span><span class="p">,</span> <span class="n">nkptgw</span><span class="o">=</span><span class="n">nkptgw</span><span class="p">,</span> <span class="n">bdgw</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bdgw</span><span class="p">,</span> <span class="p">(</span><span class="n">nkptgw</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">LujForSpecie</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;LdauForSpecie&quot;</span><span class="p">,</span> <span class="s2">&quot;l u j unit&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the value of l, u, j used for a single atomic specie.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            l: Angular momentum (int or string).</span>
<span class="sd">            u: U value</span>
<span class="sd">            j: J Value</span>
<span class="sd">            unit: Energy unit for u and j.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">l</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">Energy</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">unit</span><span class="p">),</span> <span class="n">Energy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">LujForSpecie</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>


<div class="viewcode-block" id="LdauParams"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.LdauParams">[docs]</a><span class="k">class</span> <span class="nc">LdauParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the parameters for LDA+U calculations with the PAW method</span>
<span class="sd">    It facilitates the specification of the U-J parameters in the Abinit input file.</span>
<span class="sd">    (see `to_abivars`). The U-J operator will be applied only on the atomic species </span>
<span class="sd">    that have been selected by calling `lui_for_symbol`.</span>

<span class="sd">    To setup the Abinit variables for a LDA+U calculation in NiO with a </span>
<span class="sd">    U value of 5 eV applied on the nickel atoms:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        luj_params = LdauParams(usepawu=1, structure=nio_structure)</span>
<span class="sd">        # Apply U-J on Ni only.</span>
<span class="sd">        u = 5.0 </span>
<span class="sd">        luj_params.luj_for_symbol(&quot;Ni&quot;, l=2, u=u, j=0.1*u, unit=&quot;eV&quot;)</span>

<span class="sd">        print(luj_params.to_abivars())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usepawu</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arg:</span>
<span class="sd">            usepawu: ABINIT variable `usepawu` defining the LDA+U method.</span>
<span class="sd">            structure: :class:`Structure` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usepawu</span> <span class="o">=</span> <span class="n">usepawu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="p">{}</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbols_by_typat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">types_of_specie</span><span class="p">]</span>

<div class="viewcode-block" id="LdauParams.luj_for_symbol"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.LdauParams.luj_for_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">luj_for_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            symbol: Chemical symbol of the atoms on which LDA+U should be applied.</span>
<span class="sd">            l: Angular momentum.</span>
<span class="sd">            u: Value of U.</span>
<span class="sd">            j: Value of J.</span>
<span class="sd">            unit: Energy unit of U and J.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_by_typat</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symbol </span><span class="si">%s</span><span class="s2"> not in symbols_by_typat:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_by_typat</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symbol </span><span class="si">%s</span><span class="s2"> is already present in LdauParams! Cannot overwrite:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">symbol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">LujForSpecie</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="LdauParams.to_abivars"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.LdauParams.to_abivars">[docs]</a>    <span class="k">def</span> <span class="nf">to_abivars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dict with the Abinit variables.&quot;&quot;&quot;</span>
        <span class="n">lpawu</span><span class="p">,</span> <span class="n">upawu</span><span class="p">,</span> <span class="n">jpawu</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_by_typat</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">j</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

            <span class="n">lpawu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> 
            <span class="n">upawu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
            <span class="n">jpawu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>

        <span class="c1"># convert upawu and jpaw to string so that we can use </span>
        <span class="c1"># eV unit in the Abinit input file (much more readable).</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">usepawu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usepawu</span><span class="p">,</span>
            <span class="n">lpawu</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lpawu</span><span class="p">)),</span>
            <span class="n">upawu</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">upawu</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; eV&quot;</span><span class="p">,</span>
            <span class="n">jpawu</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">jpawu</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; eV&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LexxParams"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.LexxParams">[docs]</a><span class="k">class</span> <span class="nc">LexxParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the parameters for local exact exchange calculations with the PAW method</span>
<span class="sd">    It facilitates the specification of the LEXX parameters in the Abinit input file.</span>
<span class="sd">    (see `to_abivars`). The LEXX operator will be applied only on the atomic species </span>
<span class="sd">    that have been selected by calling `lexx_for_symbol`.</span>

<span class="sd">    To perform a LEXX calculation for NiO in which the LEXX is computed only for the l=2</span>
<span class="sd">    channel of the nickel atoms:</span>
<span class="sd">                                                                         </span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">        lexx_params = LexxParams(nio_structure)</span>
<span class="sd">        lexx_params.lexx_for_symbol(&quot;Ni&quot;, l=2)</span>

<span class="sd">        print(lexc_params.to_abivars())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arg:</span>
<span class="sd">            structure: :class:`Structure` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lexx_for_symbol</span> <span class="o">=</span> <span class="p">{}</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbols_by_typat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">types_of_specie</span><span class="p">]</span>

<div class="viewcode-block" id="LexxParams.lexx_for_symbol"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.LexxParams.lexx_for_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">lexx_for_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable LEXX for the given chemical symbol and the angular momentum l </span>

<span class="sd">        Args:</span>
<span class="sd">            symbol: Chemical symbol of the atoms on which LEXX should be applied.</span>
<span class="sd">            l: Angular momentum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_by_typat</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Symbol </span><span class="si">%s</span><span class="s2"> not in symbols_by_typat:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_by_typat</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lexx_for_symbol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symbol </span><span class="si">%s</span><span class="s2"> is already present in LdauParams! Cannot overwrite:&quot;</span> <span class="o">%</span> <span class="n">symbol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lexx_for_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span></div>

<div class="viewcode-block" id="LexxParams.to_abivars"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.LexxParams.to_abivars">[docs]</a>    <span class="k">def</span> <span class="nf">to_abivars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dict with the Abinit variables.&quot;&quot;&quot;</span>
        <span class="n">lexx_typat</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_by_typat</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lexx_for_symbol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lexx_typat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> 

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">useexexch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lexexch</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lexx_typat</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="input_gen"><a class="viewcode-back" href="../../../api/htc/input.html#abipy.htc.input.input_gen">[docs]</a><span class="k">def</span> <span class="nf">input_gen</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function receives an :class:`AbiInput` and generates</span>
<span class="sd">    new inputs by replacing the variables specified in kwargs.</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: :class:`AbiInput` file.</span>
<span class="sd">        kwargs: keyword arguments with the values used for each variable.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        gs_inp = call_function_to_generate_initial_template()</span>

<span class="sd">        # To generate two input files with different values of ecut:</span>
<span class="sd">        for inp_ecut in input_gen(gs_inp, ecut=[10, 20]):</span>
<span class="sd">            print(&quot;do something with inp_ecut %s&quot; % inp_ecut)</span>

<span class="sd">        # To generate four input files with all the possible combinations of ecut and nsppol:</span>
<span class="sd">        for inp_ecut in input_gen(gs_inp, ecut=[10, 20], nsppol=[1, 2]):</span>
<span class="sd">            print(&quot;do something with inp_ecut %s&quot; % inp_ecut)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">new_vars</span> <span class="ow">in</span> <span class="n">product_dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new_inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="c1"># Remove the variable names to avoid annoying warnings if the variable is overwritten.</span>
        <span class="n">new_inp</span><span class="o">.</span><span class="n">remove_vars</span><span class="p">(</span><span class="n">new_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">new_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="n">new_vars</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">new_inp</span></div>


<span class="k">def</span> <span class="nf">product_dict</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function receives a dictionary d where each key defines a list of items or a simple scalar.</span>
<span class="sd">    It constructs the Cartesian product of the values (equivalent to nested for-loops),</span>
<span class="sd">    and returns a list of dictionaries with the values that would be used inside the loop.</span>

<span class="sd">    &gt;&gt;&gt; d = OrderedDict([(&quot;foo&quot;, [2, 4]), (&quot;bar&quot;, 1)])</span>
<span class="sd">    &gt;&gt;&gt; product_dict(d) == [OrderedDict([(&#39;foo&#39;, 2), (&#39;bar&#39;, 1)]), OrderedDict([(&#39;foo&#39;, 4), (&#39;bar&#39;, 1)])]</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; d = OrderedDict([(&quot;bar&quot;, [1,2]), (&#39;foo&#39;, [3,4])]) </span>
<span class="sd">    &gt;&gt;&gt; product_dict(d) == [{&#39;bar&#39;: 1, &#39;foo&#39;: 3},</span>
<span class="sd">    ... {&#39;bar&#39;: 1, &#39;foo&#39;: 4},</span>
<span class="sd">    ... {&#39;bar&#39;: 2, &#39;foo&#39;: 3},</span>
<span class="sd">    ... {&#39;bar&#39;: 2, &#39;foo&#39;: 4}]</span>
<span class="sd">    True</span>

<span class="sd">    .. warning:</span>

<span class="sd">        Dictionaries are not ordered, therefore one cannot assume that </span>
<span class="sd">        the order of the keys in the output equals the one used to loop.</span>
<span class="sd">        If the order is important, one should pass a :class:`OrderedDict` in input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="c1"># Each item in vals must be iterable.</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span> <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># Build list of dictionaries. Use ordered dicts so that </span>
    <span class="c1"># we preserve the order when d is an OrderedDict.</span>
    <span class="n">vars_prod</span> <span class="o">=</span> <span class="p">[]</span> 

    <span class="k">for</span> <span class="n">prod_values</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="n">dprod</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">prod_values</span><span class="p">))</span>
        <span class="n">vars_prod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dprod</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vars_prod</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, The ABINIT group.
      Last updated on Mar 07, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>