

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>abipy.electrons.bse &mdash; abipy 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="abipy 0.1.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../whats_new.html">What&#8217;s new in abipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts.html">Command line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/plot/index.html">plot Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devel/index.html">The AbiPy Developers&#8217; Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">abipy</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>abipy.electrons.bse</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.electrons.bse</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Classes for the analysis of BSE calculations&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="k">import</span> <span class="n">AttrDict</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">marquee</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.plotting</span> <span class="k">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span>
<span class="kn">from</span> <span class="nn">abipy.core.func1d</span> <span class="k">import</span> <span class="n">Function1D</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="k">import</span> <span class="n">Kpoint</span><span class="p">,</span> <span class="n">KpointList</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.tensor</span> <span class="k">import</span> <span class="n">SymmetricTensor</span>
<span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="k">import</span> <span class="n">ETSF_Reader</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;DielectricTensor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DielectricFunction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MdfFile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MdfReader&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MdfPlotter&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="DielectricTensor"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricTensor">[docs]</a><span class="k">class</span> <span class="nc">DielectricTensor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the frequency-dependent macroscopic dielectric tensor</span>
<span class="sd">    obtained from the dielectric functions for different q-directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">nfreq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">wmesh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wmesh</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">wmesh</span>

        <span class="c1"># Transform mdf emacros_q to numpy array</span>
        <span class="n">all_emacros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">emacro</span> <span class="ow">in</span> <span class="n">mdf</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">:</span>
            <span class="n">all_emacros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">emacro</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">all_emacros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_emacros</span><span class="p">)</span>

        <span class="c1"># One tensor for each frequency</span>
        <span class="n">all_tensors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ifrq</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">wmesh</span><span class="p">):</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">SymmetricTensor</span><span class="o">.</span><span class="n">from_directions</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">qfrac_coords</span><span class="p">,</span> <span class="n">all_emacros</span><span class="p">[:,</span><span class="n">ifrq</span><span class="p">],</span>
                                                     <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="n">all_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_tensors</span> <span class="o">=</span> <span class="n">all_tensors</span>

<div class="viewcode-block" id="DielectricTensor.to_array"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricTensor.to_array">[docs]</a>    <span class="k">def</span> <span class="nf">to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tensors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">red_coords</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">reduced_tensor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">cartesian_tensor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>

<div class="viewcode-block" id="DielectricTensor.symmetrize"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricTensor.symmetrize">[docs]</a>    <span class="k">def</span> <span class="nf">symmetrize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tensors</span><span class="p">:</span>
            <span class="n">tensor</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></div>

<div class="viewcode-block" id="DielectricTensor.to_func1d"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricTensor.to_func1d">[docs]</a>    <span class="k">def</span> <span class="nf">to_func1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">red_coords</span><span class="p">)</span>

        <span class="n">all_funcs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">all_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wmesh</span><span class="p">,</span> <span class="n">table</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">all_funcs</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="DielectricTensor.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricTensor.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot all the components of the tensor</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        kwargs          Meaning</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        red_coords      True to plot the reduced coordinate tensor (Default: True)</span>
<span class="sd">        ==============  ==============================================================</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">red_coords</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;red_coords&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [eV]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dielectric tensor&#39;</span><span class="p">)</span>

        <span class="c1">#if not kwargs:</span>
        <span class="c1">#    kwargs = {&quot;color&quot;: &quot;black&quot;, &quot;linewidth&quot;: 2.0}</span>

        <span class="c1"># Plot the 6 independent components</span>
        <span class="k">for</span> <span class="n">icomponent</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">icomponent</span><span class="p">,</span> <span class="n">red_coords</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="DielectricTensor.plot_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricTensor.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">red_coords</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot data on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: plot axis</span>
<span class="sd">            what: Sequential index of the tensor matrix element.</span>
<span class="sd">            args: Positional arguments passed to ax.plot</span>
<span class="sd">            kwargs: Keyword arguments passed to matplotlib. Accepts also:</span>

<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        kwargs          Meaning</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        cplx_mode:      string defining the data to print (case-insensitive).</span>
<span class="sd">                        Possible choices are:</span>

<span class="sd">                            - &quot;re&quot;  for real part</span>
<span class="sd">                            - &quot;im&quot; for imaginary part only.</span>
<span class="sd">                            - &quot;abs&#39; for the absolute value</span>

<span class="sd">                        Options can be concated with &quot;-&quot;.</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the function to plot according to qpoint.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_func1d</span><span class="p">(</span><span class="n">red_coords</span><span class="p">)[</span><span class="n">what</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DielectricFunction"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction">[docs]</a><span class="k">class</span> <span class="nc">DielectricFunction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the frequency-dependent macroscopic dielectric function</span>
<span class="sd">    computed for different q-directions in reciprocal space.</span>

<span class="sd">    .. note:</span>
<span class="sd">        Frequencies are in eV</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">qpoints</span><span class="p">,</span> <span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: :class: Structure object.</span>
<span class="sd">            qpoints: :class:`KpointList` with the qpoints in reduced coordinates.</span>
<span class="sd">            wmesh: Array-like object with the frequency mesh (eV).</span>
<span class="sd">            emacros_q: Iterable with the macroscopic dielectric function for the different q-points.</span>
<span class="sd">            info: Dictionary containing info on the calculation that produced</span>
<span class="sd">                  the results (read from file). It must contain the following keywords:</span>

<span class="sd">                    - &quot;lfe&quot;: True if local field effects are included.</span>
<span class="sd">                    - &quot;calc_type&quot;: string defining the calculation type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="n">qpoints</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">emacros_q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">,</span> <span class="n">em_avg</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wmesh</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">emq</span> <span class="ow">in</span> <span class="n">emacros_q</span><span class="p">:</span>
            <span class="n">em_avg</span> <span class="o">+=</span> <span class="n">emq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function1D</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">)</span>

        <span class="c1"># Compute the average value.</span>
        <span class="c1"># TODO: One should take into account the star of q, but I need the symops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emacro_avg</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">em_avg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over (q, em_q).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qfrac_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The fractional coordinates of the q-points as a ndarray.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">frac_coords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_lfe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if MDF includes local field effects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;lfe&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String with the type of calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;calc_type&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="DielectricFunction.show_info"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction.show_info">[docs]</a>    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pretty print of the info.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pprint</span>
        <span class="n">printer</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="n">printer</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="DielectricFunction.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the MDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        kwargs          Meaning</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        only_mean       True if only the averaged spectrum is wanted (default True)</span>
<span class="sd">        ==============  ==============================================================</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">only_mean</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;only_mean&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [eV]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Macroscopic DF&#39;</span><span class="p">)</span>

        <span class="c1">#if not kwargs:</span>
        <span class="c1">#    kwargs = {&quot;color&quot;: &quot;black&quot;, &quot;linewidth&quot;: 2.0}</span>

        <span class="c1"># Plot the average value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_mean</span><span class="p">:</span>
            <span class="c1"># Plot the q-points</span>
            <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="DielectricFunction.plot_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot data on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: plot axis.</span>
<span class="sd">            qpoint: index of the q-point or Kpoint object or None) to plot emacro_avg.</span>
<span class="sd">            kwargs: Keyword arguments passed to matplotlib. Accepts also:</span>

<span class="sd">                cplx_mode:</span>
<span class="sd">                    string defining the data to print (case-insensitive).</span>
<span class="sd">                    Possible choices are</span>

<span class="sd">                        - &quot;re&quot;  for real part</span>
<span class="sd">                        - &quot;im&quot; for imaginary part only.</span>
<span class="sd">                        - &quot;abs&#39; for the absolute value</span>

<span class="sd">                    Options can be concated with &quot;-&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the function to plot according to qpoint.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qpoint</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">[</span><span class="n">qpoint</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qpoint</span><span class="p">,</span> <span class="n">Kpoint</span><span class="p">):</span>
            <span class="n">iq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacro_avg</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qpoint</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MdfFile"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile">[docs]</a><span class="k">class</span> <span class="nc">MdfFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with MdfFile(&quot;foo_MDF.nc&quot;) as mdf:</span>
<span class="sd">            mdf.plot_mdfs()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MdfFile.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.from_file">[docs]</a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a Netcdf file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MdfFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">MdfReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># TODO Add electron Bands.</span>
        <span class="c1">#self._ebands = r.read_ebands()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="MdfFile.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Structure&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Q-points&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.close"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="MdfFile.structure"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.structure">[docs]</a>    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the `Structure` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="MdfFile.exc_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.exc_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">exc_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Excitonic macroscopic dieletric function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_exc_mdf</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="MdfFile.rpanlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.rpanlf_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">rpanlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;RPA dielectric function without local-field effects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_rpanlf_mdf</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="MdfFile.gwnlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.gwnlf_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">gwnlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;RPA-GW dielectric function without local-field effects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_gwnlf_mdf</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">qpoints</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qfrac_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The fractional coordinates of the q-points as a ndarray.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">frac_coords</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="MdfFile.params"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.params">[docs]</a>    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary with the parameters that are usually tested for convergence.</span>
<span class="sd">        Used to build Pandas dataframes in Robots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span></div>

<div class="viewcode-block" id="MdfFile.get_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.get_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">get_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;exc&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Returns the macroscopic dielectric function.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;exc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc_mdf</span><span class="p">,</span>
             <span class="s2">&quot;rpa&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpanlf_mdf</span><span class="p">,</span>
             <span class="s2">&quot;gwrpa&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwnlf_mdf</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">mdf_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for mdf_type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mdf_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.plot_mdfs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.plot_mdfs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_mdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;Im&quot;</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the macroscopic dielectric function.</span>

<span class="sd">        Args:</span>
<span class="sd">            cplx_mode:</span>
<span class="sd">                string defining the data to print (case-insensitive).</span>
<span class="sd">                Possible choices are</span>

<span class="sd">                    - &quot;re&quot;  for real part</span>
<span class="sd">                    - &quot;im&quot; for imaginary part only.</span>
<span class="sd">                    - &quot;abs&#39; for the absolute value</span>

<span class="sd">                Options can be concated with &quot;-&quot;.</span>

<span class="sd">            mdf_type:</span>
<span class="sd">                Select the type of macroscopic dielectric function.</span>
<span class="sd">                Possible choices are</span>

<span class="sd">                    - &quot;exc&quot; for the excitonic MDF.</span>
<span class="sd">                    - &quot;rpa&quot; for RPA MDF.</span>
<span class="sd">                    - &quot;gwrpa&quot; for GW-RPA MDF</span>
<span class="sd">                    - &quot;all&quot; if all types are wanted.</span>

<span class="sd">                Options can be concated with &quot;-&quot;.</span>

<span class="sd">            qpoint:</span>
<span class="sd">                index of the q-point or Kpoint object or None to plot emacro_avg.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mdf_type</span><span class="p">,</span> <span class="n">cplx_mode</span> <span class="o">=</span> <span class="n">mdf_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">cplx_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">plot_all</span> <span class="o">=</span> <span class="n">mdf_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span>
        <span class="n">mdf_type</span> <span class="o">=</span> <span class="n">mdf_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

        <span class="c1"># Build the plotter.</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">MdfPlotter</span><span class="p">()</span>

        <span class="c1"># Excitonic MDF.</span>
        <span class="k">if</span> <span class="s2">&quot;exc&quot;</span> <span class="ow">in</span> <span class="n">mdf_type</span> <span class="ow">or</span> <span class="n">plot_all</span><span class="p">:</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mdf</span><span class="p">(</span><span class="s2">&quot;EXC&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc_mdf</span><span class="p">)</span>

        <span class="c1"># KS-RPA MDF</span>
        <span class="k">if</span> <span class="s2">&quot;rpa&quot;</span> <span class="ow">in</span> <span class="n">mdf_type</span> <span class="ow">or</span> <span class="n">plot_all</span><span class="p">:</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mdf</span><span class="p">(</span><span class="s2">&quot;KS-RPA&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpanlf_mdf</span><span class="p">)</span>

        <span class="c1"># GW-RPA MDF (obtained with the scissors operator).</span>
        <span class="k">if</span> <span class="s2">&quot;gwrpa&quot;</span> <span class="ow">in</span> <span class="n">mdf_type</span> <span class="ow">or</span> <span class="n">plot_all</span><span class="p">:</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mdf</span><span class="p">(</span><span class="s2">&quot;GW-RPA&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwnlf_mdf</span><span class="p">)</span>

        <span class="c1"># Plot spectra</span>
        <span class="k">return</span> <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cplx_mode</span><span class="o">=</span><span class="n">cplx_mode</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="n">qpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.get_tensor"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.get_tensor">[docs]</a>    <span class="k">def</span> <span class="nf">get_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;exc&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the macroscopic dielectric tensor from the MDF.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DielectricTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mdf</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an ipython notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;mdf_file = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(mdf_file)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = mdf_file.plot_mdfs(cplx_mode=&#39;Re&#39;)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = mdf_file.plot_mdfs(cplx_mode=&#39;Im&#39;)&quot;</span><span class="p">),</span>
            <span class="c1"># TODO:</span>
            <span class="c1">#nbv.new_code_cell(&quot;tensor_exc = mdf_file.get_tensor(&quot;exc&quot;)&quot;)</span>
            <span class="c1">#tensor_exc.symmetrize(mdf_file.structure)</span>
            <span class="c1">#tensor_exc.plot(title=title)</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="c1"># TODO Add band energies to MDF file.</span>
<span class="c1">#from abipy.electrons import ElectronsReader</span>
<div class="viewcode-block" id="MdfReader"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader">[docs]</a><span class="k">class</span> <span class="nc">MdfReader</span><span class="p">(</span><span class="n">ETSF_Reader</span><span class="p">):</span> <span class="c1">#ElectronsReader</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object reads data from the MDF.nc file produced by ABINIT.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a filename.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MdfReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># Read the structure here to facilitate the creation of the other objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="MdfReader.qpoints"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.qpoints">[docs]</a>    <span class="k">def</span> <span class="nf">qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of q-points (ndarray).&quot;&quot;&quot;</span>
        <span class="c1"># Read the fractional coordinates and convert them to KpointList.</span>
        <span class="k">return</span> <span class="n">KpointList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">frac_coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpoints&quot;</span><span class="p">))</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="MdfReader.wmesh"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.wmesh">[docs]</a>    <span class="k">def</span> <span class="nf">wmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The frequency mesh in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;wmesh&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfReader.read_params"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_params">[docs]</a>    <span class="k">def</span> <span class="nf">read_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the parameters of the run.&quot;&quot;&quot;</span>
        <span class="c1"># TODO</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nsppol&quot;</span><span class="p">,</span> <span class="s2">&quot;ecutwfn&quot;</span><span class="p">,</span> <span class="s2">&quot;ecuteps&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eps_inf&quot;</span><span class="p">,</span> <span class="s2">&quot;soenergy&quot;</span><span class="p">,</span> <span class="s2">&quot;broad&quot;</span><span class="p">,</span> <span class="s2">&quot;nkibz&quot;</span><span class="p">,</span> <span class="s2">&quot;nkbz&quot;</span><span class="p">,</span> <span class="s2">&quot;nkibz_interp&quot;</span><span class="p">,</span> <span class="s2">&quot;nkbz_interp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wtype&quot;</span><span class="p">,</span> <span class="s2">&quot;interp_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;nreh&quot;</span><span class="p">,</span> <span class="s2">&quot;lomo_spin&quot;</span><span class="p">,</span> <span class="s2">&quot;humo_spin&quot;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_keys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the MDF from file, returns numpy complex array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MdfReader.read_exc_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_exc_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">read_exc_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the excitonic MDF.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span>
        <span class="n">emacros_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mdf</span><span class="p">(</span><span class="s2">&quot;exc_mdf&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DielectricFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfReader.read_rpanlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_rpanlf_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">read_rpanlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the KS-RPA MDF without LF effects.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span>
        <span class="n">emacros_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mdf</span><span class="p">(</span><span class="s2">&quot;rpanlf_mdf&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DielectricFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfReader.read_gwnlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_gwnlf_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">read_gwnlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the GW-RPA MDF without LF effects.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span>
        <span class="n">emacros_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mdf</span><span class="p">(</span><span class="s2">&quot;gwnlf_mdf&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DielectricFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MdfPlotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfPlotter">[docs]</a><span class="k">class</span> <span class="nc">MdfPlotter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting multiple MDFs.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = MdfPlotter()</span>
<span class="sd">        plotter.add_mdf_from_file(&quot;foo_MDF.nc&quot;, label=&quot;foo mdf&quot;)</span>
<span class="sd">        plotter.add_mdf_from_file(&quot;bar_MDF.nc&quot;, label=&quot;bar mdf&quot;)</span>
<span class="sd">        plotter.plot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

<div class="viewcode-block" id="MdfPlotter.add_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfPlotter.add_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">add_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mdf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a :class:`DielectricFunction` for plotting.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name for the MDF. Must be unique.</span>
<span class="sd">            mdf: :class:`DielectricFunction` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;name </span><span class="si">%s</span><span class="s2"> is already in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span></div>

<div class="viewcode-block" id="MdfPlotter.add_mdf_from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfPlotter.add_mdf_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_mdf_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;exc&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a mdf for plotting. Reads data from file filepaths.</span>

<span class="sd">        Args:</span>
<span class="sd">            mdf_type: String defining the type of mdf.</span>
<span class="sd">            name: Optional string used to name the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="k">import</span> <span class="n">abiopen</span>
        <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>
            <span class="n">mdf</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">get_mdf</span><span class="p">(</span><span class="n">mdf_type</span><span class="o">=</span><span class="n">mdf_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">mdf_type</span> <span class="o">+</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_mdf</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mdf</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="MdfPlotter.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfPlotter.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;Im&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a matplotlib plot showing the MDFs.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            cplx_mode: string defining the data to print (case-insensitive).</span>
<span class="sd">                Possible choices are `re` for the real part, `im` for imaginary part only. `abs` for the absolute value.</span>
<span class="sd">                Options can be concated with &quot;-&quot;.</span>
<span class="sd">            qpoint: index of the q-point or :class:`Kpoint` object or None to plot emacro_avg.</span>

<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        kwargs          Meaning</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        xlim            x-axis limits. None (Default) for automatic determination.</span>
<span class="sd">        ylim            y-axis limits. None (Default) for automatic determination.</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">xlim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;xlim&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

        <span class="n">ylim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ylim&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [eV]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Macroscopic DF&#39;</span><span class="p">)</span>

        <span class="n">cmodes</span> <span class="o">=</span> <span class="n">cplx_mode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">qtag</span> <span class="o">=</span> <span class="s2">&quot;avg&quot;</span> <span class="k">if</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">repr</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>

        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mdf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Plot the q-points</span>
            <span class="c1">#for (iq, qpoint) in enumerate(self.qpoints):</span>
            <span class="c1">#    self.plot_ax(ax, iq, **kwargs)</span>

            <span class="k">for</span> <span class="n">cmode</span> <span class="ow">in</span> <span class="n">cmodes</span><span class="p">:</span>
                <span class="c1"># Plot the average value</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="n">cmode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> $\,</span><span class="se">\\</span><span class="s2">varepsilon$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmode</span><span class="p">,</span> <span class="n">qtag</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

        <span class="c1"># Set legends.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, The ABINIT group.
      Last updated on Mar 09, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>