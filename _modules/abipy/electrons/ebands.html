

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>abipy.electrons.ebands &mdash; abipy 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="abipy 0.1.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../whats_new.html">What&#8217;s new in abipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts.html">Command line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/plot/index.html">plot Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devel/index.html">The AbiPy Developers&#8217; Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">abipy</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>abipy.electrons.ebands</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.electrons.ebands</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Classes for the analysis of electronic structures.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymatgen.core.units</span> <span class="k">as</span> <span class="nn">units</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">is_string</span><span class="p">,</span> <span class="n">marquee</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="k">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">MSONable</span><span class="p">,</span> <span class="n">MontyEncoder</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="k">import</span> <span class="n">AttrDict</span><span class="p">,</span> <span class="n">dict2namedtuple</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.bisect</span> <span class="k">import</span> <span class="n">find_le</span><span class="p">,</span> <span class="n">find_gt</span>
<span class="kn">from</span> <span class="nn">monty.dev</span> <span class="k">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">pymatgen.serializers.json_coders</span> <span class="k">import</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">abipy.core.func1d</span> <span class="k">import</span> <span class="n">Function1D</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="k">import</span> <span class="p">(</span><span class="n">Kpoint</span><span class="p">,</span> <span class="n">KpointList</span><span class="p">,</span> <span class="n">Kpath</span><span class="p">,</span> <span class="n">IrredZone</span><span class="p">,</span> <span class="n">KSamplingInfo</span><span class="p">,</span> <span class="n">KpointsReaderMixin</span><span class="p">,</span>
    <span class="n">kmesh_from_mpdivs</span><span class="p">,</span> <span class="n">Ktables</span><span class="p">,</span> <span class="n">has_timrev_from_kptopt</span><span class="p">,</span> <span class="n">map_bz2ibz</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="k">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="k">import</span> <span class="n">ETSF_Reader</span><span class="p">,</span> <span class="n">bxsf_write</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="k">import</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="k">import</span> <span class="n">set_axlims</span><span class="p">,</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">Marker</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ElectronBands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ElectronDos&quot;</span><span class="p">,</span>
    <span class="s2">&quot;frame_from_ebands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ElectronBandsPlotter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ElectronDosPlotter&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">Electron</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Electron&quot;</span><span class="p">,</span> <span class="s2">&quot;spin kpoint band eig occ kidx&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Single-particle state.</span>

<span class="sd">    .. Attributes:</span>

<span class="sd">        spin: spin index (C convention, i.e &gt;= 0)</span>
<span class="sd">        kpoint: :class:`Kpoint` object.</span>
<span class="sd">        band: band index. (C convention, i.e &gt;= 0).</span>
<span class="sd">        eig: KS eigenvalue.</span>
<span class="sd">        occ: Occupation factor.</span>
<span class="sd">        kidx: Index of the k-point in the initial array.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Energies are in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#def __eq__(self, other):</span>
    <span class="c1">#    return (self.spin = other.spin and</span>
    <span class="c1">#            self.kpoint == other.kpoint and</span>
    <span class="c1">#            self.band == other.band and</span>
    <span class="c1">#            self.eig == other.eig</span>
                 <span class="c1"># and self.occ == other.occ</span>
    <span class="c1">#            )</span>

    <span class="c1">#def __ne__(self, other):</span>
    <span class="c1">#    return not self == other</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;spin=</span><span class="si">%d</span><span class="s2">, kpt=</span><span class="si">%s</span><span class="s2">, band=</span><span class="si">%d</span><span class="s2">, eig=</span><span class="si">%.3f</span><span class="s2">, occ=</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occ</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple with (spin, kpoint, band).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Electron</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">})</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert self into a dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Electron</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">to_strdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ordered dictionary mapping fields --&gt; strings.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-3</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">real</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f%+.2f</span><span class="s2">j&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="c1">#print(&quot;k&quot;, k, str(exc))</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the description of the fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">TIPS</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">TIPS</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method that returns a dictionary with the description of the fields.</span>
<span class="sd">        The string are extracted from the class doc string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_TIPS</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Parse the doc string.</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_TIPS</span> <span class="o">=</span> <span class="n">_TIPS</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__doc__</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.. Attributes&quot;</span><span class="p">):</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">break</span>

            <span class="k">def</span> <span class="nf">num_leadblanks</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the number of the leading whitespaces in a string&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
                        <span class="n">nblanks</span> <span class="o">=</span> <span class="n">num_leadblanks</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="k">if</span> <span class="n">nblanks</span> <span class="o">==</span> <span class="n">num_leadblanks</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                <span class="k">break</span>
                            <span class="n">desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

                        <span class="n">_TIPS</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

            <span class="n">diffset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_TIPS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">diffset</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The following fields are not documented: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">diffset</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">_TIPS</span>


<span class="k">class</span> <span class="nc">ElectronTransition</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object describes an electronic transition between two single-particle states.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_state</span><span class="p">,</span> <span class="n">out_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            in_state, out_state: Initial and finale state (:class:`Electron` instances).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span> <span class="o">=</span> <span class="n">in_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span> <span class="o">=</span> <span class="n">out_state</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Energy: </span><span class="si">%.3f</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Initial state: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Final state:   </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1">#def __eq__(self, other):</span>
    <span class="c1">#    if other is None: return False</span>
    <span class="c1">#    if not isinstance(other, self.__class__): return False</span>
    <span class="c1">#    return self.in_state == other.in_state and</span>
    <span class="c1">#           self.out_state == other.out_state</span>

    <span class="c1">#def __ne__(self, other):</span>
    <span class="c1">#    return not self == other</span>

    <span class="c1">#def __ge__(self, other):</span>
    <span class="c1">#    return self.energy &gt;= other.energy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transition energy in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">eig</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;k_final - k_initial&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">kpoint</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_direct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if direct transition.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">kpoint</span>


<span class="k">class</span> <span class="nc">Smearing</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores data and information about the smearing technique.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_MANDATORY_KEYS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;scheme&quot;</span><span class="p">,</span>
        <span class="s2">&quot;occopt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tsmear_ev&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes Smearing obey the general json interface used in pymatgen for easier serialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_MANDATORY_KEYS</span><span class="p">})</span>

    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes Smearing obey the general json interface used in pymatgen for easier serialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a json string representation of the MSONable object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="n">cls</span><span class="o">=</span><span class="n">MontyEncoder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Smearing</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MANDATORY_KEYS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mandatory key </span><span class="si">%s</span><span class="s2"> must be provided&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mkey</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;smearing scheme: </span><span class="si">%s</span><span class="s2">, tsmear_eV: </span><span class="si">%.3f</span><span class="s2">, occopt: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsmear_ev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occopt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_metallic_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are using a metallic scheme for occupancies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occopt</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">StatParams</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;StatParams&quot;</span><span class="p">,</span> <span class="s2">&quot;mean stdev min max&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Named tuple with statistical parameters.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;mean = </span><span class="si">%.3f</span><span class="s2">, stdev = </span><span class="si">%.3f</span><span class="s2">, min = </span><span class="si">%.3f</span><span class="s2">, max = </span><span class="si">%.3f</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ElectronBandsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exceptions raised by ElectronBands.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ElectronBands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands">[docs]</a><span class="k">class</span> <span class="nc">ElectronBands</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the electronic band structure.</span>

<span class="sd">    .. attribute:: fermie</span>

<span class="sd">            Fermi level in eV. Note that, if the band structure has been computed</span>
<span class="sd">            with a NSCF run, fermie corresponds to the fermi level obtained</span>
<span class="sd">            in the SCF run that produced the density used for the band structure calculation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">ElectronBandsError</span>

    <span class="c1"># FIXME</span>
    <span class="c1"># Increase a bit the value of fermie used in bisection routines to solve the problem mentioned below</span>
    <span class="n">pad_fermie</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span>
    <span class="c1"># One should check whether fermie is recomputed at the end of the SCF cyle</span>
    <span class="c1"># I have problems in finding homos/lumos in semiconductors (e.g. Si)</span>
    <span class="c1"># because fermie is slightly smaller than the CBM:</span>

    <span class="c1"># fermie 5.59845327874</span>
    <span class="c1"># homos [Electron(spin=0, kpoint=[0.000, 0.000, 0.000], band=1, eig=5.5984532787385985, occ=2.0)]</span>
    <span class="c1"># lumos [Electron(spin=0, kpoint=[0.000, 0.000, 0.000], band=2, eig=5.5984532788661543, occ=2.0)]</span>
    <span class="c1">#</span>
    <span class="c1"># There&#39;s also another possible problem if the DEN is computed on a grid that does not contain the CBM (e.g. Gamma)</span>
    <span class="c1"># because the CBM obtained with the NSCF band structure run will be likely above the Ef computed previously.</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ElectronBands.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.from_file">[docs]</a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize an instance of :class:`ElectronBands` from a netCDF file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">ElectronsReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_ebands</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;ElectronBands can only be initialized from nc files&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">new</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">cls</span>
        <span class="k">return</span> <span class="n">new</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ElectronBands.from_dict"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kd</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;kpoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;@module&quot;</span><span class="p">)</span>

        <span class="n">kpoints_cls</span> <span class="o">=</span> <span class="n">KpointList</span><span class="o">.</span><span class="n">subclass_from_name</span><span class="p">(</span><span class="n">kd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;@class&quot;</span><span class="p">))</span>
        <span class="c1">#kpoints = kpoints_cls(**kd)</span>
        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints_cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">kd</span><span class="p">)</span>

        <span class="c1"># Needed to support old dictionaries</span>
        <span class="k">if</span> <span class="s2">&quot;nspden&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;nspinor&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspinor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">Structure</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]),</span> <span class="n">kpoints</span><span class="p">,</span>
                   <span class="n">d</span><span class="p">[</span><span class="s2">&quot;eigens&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fermie&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;occfacts&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nelect&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspinor&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspden&quot;</span><span class="p">],</span>
                   <span class="n">nband_sk</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;nband_sk&quot;</span><span class="p">],</span> <span class="n">smearing</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;smearing&quot;</span><span class="p">],</span>
                   <span class="c1">#markers=None, widths=None</span>
                   <span class="p">)</span></div>

    <span class="nd">@pmg_serialize</span>
<div class="viewcode-block" id="ElectronBands.as_dict"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary with JSON serialization.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="n">eigens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">fermie</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">),</span>
            <span class="n">occfacts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">nelect</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">),</span>
            <span class="n">nspinor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span>
            <span class="n">nspden</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
            <span class="n">nband_sk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ElectronBands.as_ebands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.as_ebands">[docs]</a>    <span class="k">def</span> <span class="nf">as_ebands</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of :class:`ElectronBands` from a generic obj.</span>
<span class="sd">        Supports:</span>

<span class="sd">            - instances of cls</span>
<span class="sd">            - files (string) that can be open with abiopen and that provide an `ebands` attribute.</span>
<span class="sd">            - objects providing an `ebands` attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># path?</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pickle&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>

            <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="k">import</span> <span class="n">abiopen</span>
            <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">as</span> <span class="n">abifile</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;ebands&quot;</span><span class="p">):</span>
            <span class="c1"># object with ebands</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">ebands</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to extract ebands from object </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="ElectronBands.to_json"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a json string representation of the MSONable object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="n">cls</span><span class="o">=</span><span class="n">MontyEncoder</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">kpoints</span><span class="p">,</span> <span class="n">eigens</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="n">occfacts</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span><span class="p">,</span>
                 <span class="n">nband_sk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: pymatgen structure.</span>
<span class="sd">            kpoints: :class:`KpointList` instance.</span>
<span class="sd">            eigens: Array-like object with the eigenvalues (eV) stored as [s,k,b]</span>
<span class="sd">                    where s: spin , k: kpoint, b: band index</span>
<span class="sd">            fermie: Fermi level in eV.</span>
<span class="sd">            occfacts: Occupation factors (same shape as eigens)</span>
<span class="sd">            nelect: Number of valence electrons in the unit cell.</span>
<span class="sd">            nspinor: Number of spinorial components</span>
<span class="sd">            nspden: Number of indipendent density components.</span>
<span class="sd">            smearing: :class:`Smearing` object storing information on the smearing technique.</span>
<span class="sd">            nband_sk: Array-like object with the number of bands treated at each [spin,kpoint]</span>
<span class="sd">                      If not given, nband_sk is initialized from eigens.</span>
<span class="sd">            markers: Optional dictionary containing markers labelled by a string.</span>
<span class="sd">                     Each marker is a list of tuple(x, y, s) where x,and y are the position</span>
<span class="sd">                     in the graph and s is the size of the marker.</span>
<span class="sd">                     Used for plotting purpose e.g. QP data, energy derivatives...</span>
<span class="sd">            widths: Optional dictionary containing data used for the so-called fatbands</span>
<span class="sd">                    Each entry is an array of shape [nsppol, nkpt, mband] giving the width</span>
<span class="sd">                    of the band at that particular point.</span>
<span class="sd">                    Used for plotting purpose e.g. L-projections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="c1"># Eigenvalues and occupancies are stored in ndarrays ordered by [spin,kpt,band]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">eigens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_occfacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">occfacts</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occfacts</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span> <span class="o">=</span> <span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span>

        <span class="k">if</span> <span class="n">nband_sk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nband_sk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span> <span class="o">*</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="c1">#print(nband_sk)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">smearing</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">smearing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">smearing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nelect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fermie</span><span class="p">)</span>

        <span class="c1"># Recompute the Fermi level (in principle should do this only if</span>
        <span class="c1"># bands are computed on a BZ mesh with a NSCF run.</span>
        <span class="c1">#if self.kpoints.is_ibz: # and iscf &lt; 0</span>
        <span class="c1">#    self.recalc_fermie()</span>

        <span class="k">if</span> <span class="n">markers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">xys</span> <span class="ow">in</span> <span class="n">markers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">xys</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">widths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="n">widths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_width</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_auto_klabels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Find the k-point names in the pymatgen database.</span>
        <span class="c1"># We&#39;ll use _auto_klabels to label the point in the matplotlib plot</span>
        <span class="c1"># if klabels are not specified by the user.</span>
        <span class="n">_auto_klabels</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">findname_in_hsym_stars</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_auto_klabels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kpoint</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_auto_klabels</span>

    <span class="c1">#def __repr__(self):</span>
    <span class="c1">#    &quot;&quot;&quot;String representation (short version)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="c1"># Handy variables used to loop</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spin range&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nband</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nband</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nband</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kidxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Range with the index of the k-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eigenvalues in eV. ndarray with shape (nspin, nkpt, mband).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">occfacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Occupation factors. ndarray with shape (nspin, nkpt, mband).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occfacts</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reciprocal_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reciprocal lattice vectors in Angstrom.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shape of the array with the eigenvalues.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_metallic_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are using a metallic scheme for occupancies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="o">.</span><span class="n">has_metallic_scheme</span>

<div class="viewcode-block" id="ElectronBands.recalc_fermie"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.recalc_fermie">[docs]</a>    <span class="k">def</span> <span class="nf">recalc_fermie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.002</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recompute the Fermi level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nelect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nelect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span>
        <span class="n">edos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="n">ef</span> <span class="o">=</span> <span class="n">edos</span><span class="o">.</span><span class="n">find_mu</span><span class="p">(</span><span class="n">nelect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_fermie</span><span class="p">(</span><span class="n">ef</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ef</span></div>

<div class="viewcode-block" id="ElectronBands.set_fermie"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.set_fermie">[docs]</a>    <span class="k">def</span> <span class="nf">set_fermie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fermie</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="n">fermie</span></div>
        <span class="c1"># TODO: Recalculate occupations.</span>

<div class="viewcode-block" id="ElectronBands.get_dict4frame"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_dict4frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_dict4frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a :class:`OrderedDict` with the most important parameters:</span>

<span class="sd">            - Chemical formula and number of atoms.</span>
<span class="sd">            - Lattice lengths, angles and volume.</span>
<span class="sd">            - The spacegroup number computed by Abinit (set to None if not available).</span>
<span class="sd">            - The spacegroup number and symbol computed by spglib (set to None not `with_spglib`).</span>

<span class="sd">        Useful to construct pandas DataFrames</span>

<span class="sd">        Args:</span>
<span class="sd">            with_spglib: If True, spglib is invoked to get the spacegroup symbol and number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">odict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;nsppol&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;nkpt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;nband&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;nelect&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">),</span>

        <span class="p">])</span>
        <span class="n">odict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4frame</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">))</span>
        <span class="n">odict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span>

        <span class="n">bws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidths</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;bandwidth_spin</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">bws</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="n">enough_bands</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enough_bands</span><span class="p">:</span>
            <span class="n">fundamental_gaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;fundgap_spin</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">fundamental_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span>

            <span class="n">direct_gaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;dirgap_spin</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span>

        <span class="k">return</span> <span class="n">odict</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">markers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

<div class="viewcode-block" id="ElectronBands.del_marker"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.del_marker">[docs]</a>    <span class="k">def</span> <span class="nf">del_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the entry in self.markers with the specied key. All markers are removed if key is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="ElectronBands.set_marker"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.set_marker">[docs]</a>    <span class="k">def</span> <span class="nf">set_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">xys</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an entry in the markers dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: string used to label the set of markers.</span>
<span class="sd">            xys: Three iterables x,y,s where x[i],y[i] gives the</span>
<span class="sd">                 positions of the i-th markers in the plot and s[i] is the size of the marker.</span>
<span class="sd">            extend: True if the values xys should be added to a pre-existing marker.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_markers&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">extend</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">(</span><span class="o">*</span><span class="n">xys</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add xys to the previous marker set.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="o">*</span><span class="n">xys</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot overwrite key </span><span class="si">%s</span><span class="s2"> in data&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">(</span><span class="o">*</span><span class="n">xys</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">widths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Widths dictionary&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widths</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

<div class="viewcode-block" id="ElectronBands.del_width"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.del_width">[docs]</a>    <span class="k">def</span> <span class="nf">del_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the entry in self.widths with the specified key. All keys are removed if key is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widths</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="ElectronBands.set_width"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.set_width">[docs]</a>    <span class="k">def</span> <span class="nf">set_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an entry in the widths dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: string used to label the set of markers.</span>
<span class="sd">            width: array-like of positive numbers, shape is [nsppol, nkpt, mband].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_widths&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_widths</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot overwrite key </span><span class="si">%s</span><span class="s2"> in data&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">width</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found ambiguous complex entry </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found negative entry in width array </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_bzmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the k-point sampling is homogeneous.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">IrredZone</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_bzpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the bands are computed on a k-path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">Kpath</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="ElectronBands.kptopt"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.kptopt">[docs]</a>    <span class="k">def</span> <span class="nf">kptopt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The value of the kptopt input variable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;kpoints.ksampling.kptopt&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ksampling</span><span class="o">.</span><span class="n">kptopt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;ebands.kpoints.ksampling.kptopt is not defined, assuming kptopt = 1&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="ElectronBands.has_timrev"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.has_timrev">[docs]</a>    <span class="k">def</span> <span class="nf">has_timrev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if time-reversal symmetry is used in the BZ sampling.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">has_timrev_from_kptopt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kptopt</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.kindex"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.kindex">[docs]</a>    <span class="k">def</span> <span class="nf">kindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The index of the k-point in the internal list of k-points.</span>
<span class="sd">        Accepts: :class:`Kpoint` instance or integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">kpoint</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.sb_iter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.sb_iter">[docs]</a>    <span class="k">def</span> <span class="nf">sb_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator over (spin, band) indices.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span></div>

<div class="viewcode-block" id="ElectronBands.skb_iter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.skb_iter">[docs]</a>    <span class="k">def</span> <span class="nf">skb_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator over (spin, k, band) indices.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">band</span></div>

<div class="viewcode-block" id="ElectronBands.show_bz"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.show_bz">[docs]</a>    <span class="k">def</span> <span class="nf">show_bz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call `matplotlib` to show the Brillouin zone.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">show_bz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.copy"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shallow copy of self.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.deepcopy"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.deepcopy">[docs]</a>    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deep copy of self.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.degeneracies"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.degeneracies">[docs]</a>    <span class="k">def</span> <span class="nf">degeneracies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">bands_range</span><span class="p">,</span> <span class="n">tol_ediff</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list with the indices of the degenerate bands.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point index or :class:`Kpoint` object</span>
<span class="sd">            bands_range: List of band indices to analyze.</span>
<span class="sd">            tol_ediff: Tolerance on the energy difference (in eV)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tuples [(e0, bands_e0), (e1, bands_e1, ....]</span>
<span class="sd">            Each tuple stores the degenerate energy and a list with the band indices.</span>
<span class="sd">            The band structure of silicon at Gamma, for example, will produce something like:</span>
<span class="sd">            [(-6.3, [0]), (5.6, [1, 2, 3]), (8.1, [4, 5, 6])]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the index of the k-point</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>

        <span class="c1"># Extract the energies we are interested in.</span>
        <span class="n">bands_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands_list</span><span class="p">]</span>

        <span class="c1"># Group bands according to their degeneracy.</span>
        <span class="n">bstart</span><span class="p">,</span> <span class="n">deg_ebands</span> <span class="o">=</span> <span class="n">bands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[]</span>
        <span class="n">e0</span><span class="p">,</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">bstart</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">band</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">band</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">new_deg</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">e0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol_ediff</span>

            <span class="k">if</span> <span class="n">new_deg</span><span class="p">:</span>
                <span class="n">ebs</span> <span class="o">=</span> <span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                <span class="n">deg_ebands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ebs</span><span class="p">)</span>
                <span class="n">e0</span><span class="p">,</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">e</span><span class="p">,</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

        <span class="n">deg_ebands</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">e0</span><span class="p">,</span> <span class="n">bs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">deg_ebands</span></div>

<div class="viewcode-block" id="ElectronBands.enemin"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.enemin">[docs]</a>    <span class="k">def</span> <span class="nf">enemin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the minimum of the eigenvalues.&quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">spin_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="n">my_kidxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span>

        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">my_bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

        <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_kidxs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">my_bands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">my_bands</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                    <span class="n">emin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">emin</span></div>

<div class="viewcode-block" id="ElectronBands.enemax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.enemax">[docs]</a>    <span class="k">def</span> <span class="nf">enemax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the maximum of the eigenvalues.&quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">spin_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="n">my_kidxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span>

        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">my_bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

        <span class="n">emax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_kidxs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">my_bands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">my_bands</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                    <span class="n">emax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">emax</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">emax</span></div>

<div class="viewcode-block" id="ElectronBands.dispersionless_states"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.dispersionless_states">[docs]</a>    <span class="k">def</span> <span class="nf">dispersionless_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">erange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltae</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">kfact</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function detects dispersionless states.</span>
<span class="sd">        A state is dispersionless if there are more that (nkpt * kfact) energies</span>
<span class="sd">        in the energy intervale [e0-deltae, e0+deltae]</span>

<span class="sd">        Args:</span>
<span class="sd">            erange=Energy range to be analyzed in the form [emin, emax]</span>
<span class="sd">            deltae: Defines the energy interval in eV around the KS eigenvalue.</span>
<span class="sd">            kfact: Can be used to change the criterion used to detect dispersionless states.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of :class:`Electron` objects. Each item contains information on</span>
<span class="sd">            the energy, the occupation and the location of the dispersionless band.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">erange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">erange</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="n">kref</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dless_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">kref</span><span class="p">]):</span>
                <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kref</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">erange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e0</span> <span class="o">&gt;</span> <span class="n">erange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="n">hrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">e0</span> <span class="o">-</span> <span class="n">deltae</span><span class="p">,</span> <span class="n">e0</span> <span class="o">+</span> <span class="n">deltae</span><span class="p">]</span>
                <span class="n">hist</span><span class="p">,</span> <span class="n">bin_hedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,:],</span>
                    <span class="n">bins</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hrange</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">#print(&quot;hist&quot;, hist, &quot;hrange&quot;, hrange, &quot;bin_hedges&quot;, bin_hedges)</span>

                <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span> <span class="o">*</span> <span class="n">kfact</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kref</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                    <span class="n">dless_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dless_states</span></div>

<div class="viewcode-block" id="ElectronBands.raw_print"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.raw_print">[docs]</a>    <span class="k">def</span> <span class="nf">raw_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print k-points and energies on stream.&quot;&quot;&quot;</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Band structure energies in Ev.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# idx   kpt_red(1:3)  ene(b1) ene(b2) ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">fmt_k</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="s2">&quot; </span><span class="si">%.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k</span>
        <span class="n">fmt_e</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="s2">&quot; </span><span class="si">%.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# spin = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spin</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">ene_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:</span><span class="n">nb</span><span class="p">]</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">kpoint</span><span class="p">:</span> <span class="n">st</span> <span class="o">+=</span> <span class="n">fmt_k</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ene_sk</span><span class="p">:</span> <span class="n">st</span> <span class="o">+=</span> <span class="n">fmt_e</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ElectronBands.to_pdframe"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_pdframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_pdframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a pandas DataFrame with the following columns:</span>

<span class="sd">          [&#39;spin&#39;, &#39;kidx&#39;, &#39;band&#39;, &#39;eig&#39;, &#39;occ&#39;, &#39;kpoint&#39;]</span>

<span class="sd">        where:</span>

<span class="sd">        ==============  ==========================</span>
<span class="sd">        Column          Meaning</span>
<span class="sd">        ==============  ==========================</span>
<span class="sd">        spin            spin index</span>
<span class="sd">        kidx            k-point index</span>
<span class="sd">        band            band index</span>
<span class="sd">        eig             KS eigenvalue in eV.</span>
<span class="sd">        occ             Occupation of the state.</span>
<span class="sd">        kpoint          :class:`Kpoint` object</span>
<span class="sd">        ==============  ==========================</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">                The Fermi energy is saved in frame.fermie</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">eig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
                               <span class="p">(</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;kidx&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">band</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">eig</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;occ&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">band</span><span class="p">]),</span>
                               <span class="p">(</span><span class="s2">&quot;kpoint&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span>
                            <span class="p">]))</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="n">e0</span>
        <span class="k">return</span> <span class="n">frame</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBands.boxplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.boxplot">[docs]</a>    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">brange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn to draw a box plot to show distributions of eigenvalues with respect to the band index.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            brange: Only bands such as `brange[0] &lt;= band_index &lt; brange[1]` are included in the plot.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            kwargs: Keywork arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the dataframe and select bands</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pdframe</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">brange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">brange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">brange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">seaborn.apionly</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;spin&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.to_pymatgen"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_pymatgen">[docs]</a>    <span class="k">def</span> <span class="nf">to_pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a pymatgen bandstructure object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.core</span> <span class="k">import</span> <span class="n">Spin</span>
        <span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.bandstructure</span> <span class="k">import</span> <span class="n">BandStructure</span><span class="p">,</span> <span class="n">BandStructureSymmLine</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># eigenvals is a dict of energies for spin up and spin down</span>
        <span class="c1"># {Spin.up:[][],Spin.down:[][]}, the first index of the array</span>
        <span class="c1"># [][] refers to the band and the second to the index of the</span>
        <span class="c1"># kpoint. The kpoints are ordered according to the order of the</span>
        <span class="c1"># kpoints array. If the band structure is not spin polarized, we</span>
        <span class="c1"># only store one data set under Spin.up</span>
        <span class="n">eigenvals</span> <span class="o">=</span> <span class="p">{</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">eigenvals</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="n">labels_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">BandStructureSymmLine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">eigenvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span>
                                         <span class="n">labels_dict</span><span class="p">,</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BandStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">eigenvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span>
                                <span class="n">labels_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_electron_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an instance of :class:`Electron` from the spin, kpoint and band index&quot;&quot;&quot;</span>
        <span class="n">kidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">eig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kidx</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Electron</span><span class="p">(</span><span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span>
                        <span class="n">kpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">[</span><span class="n">kidx</span><span class="p">],</span>
                        <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
                        <span class="n">eig</span><span class="o">=</span><span class="n">eig</span><span class="p">,</span>
                        <span class="n">occ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kidx</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span>
                        <span class="n">kidx</span><span class="o">=</span><span class="n">kidx</span><span class="p">,</span>
                        <span class="c1">#fermie=self.fermie</span>
                        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lomos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;lomo states for each spin channel as a list of nsppol :class:`Electron`.&quot;&quot;&quot;</span>
        <span class="n">lomos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">lomo_kidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">lomos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">lomo_kidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lomos</span>

<div class="viewcode-block" id="ElectronBands.lomo_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.lomo_sk">[docs]</a>    <span class="k">def</span> <span class="nf">lomo_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the LOMO state for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: Index of the kpoint or :class:`Kpoint` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.homo_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.homo_sk">[docs]</a>    <span class="k">def</span> <span class="nf">homo_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the HOMO state for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: Index of the kpoint or :class:`Kpoint` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1"># Find rightmost value less than or equal to fermie.</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">find_le</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.lumo_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.lumo_sk">[docs]</a>    <span class="k">def</span> <span class="nf">lumo_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the LUMO state for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: Index of the kpoint or :class:`Kpoint` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1"># Find leftmost value greater than fermie.</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">find_gt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">homos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        homo states for each spin channel as a list of nsppol :class:`Electron`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">homos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">blist</span><span class="p">,</span> <span class="n">enes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="c1"># Find rightmost value less than or equal to fermie.</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">find_le</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
                <span class="n">blist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">enes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>

            <span class="n">homo_kidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">enes</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
            <span class="n">homo_band</span> <span class="o">=</span> <span class="n">blist</span><span class="p">[</span><span class="n">homo_kidx</span><span class="p">]</span>

            <span class="c1"># Build Electron instance.</span>
            <span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">homo_kidx</span><span class="p">,</span> <span class="n">homo_band</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">homos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lumos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        lumo states for each spin channel as a list of nsppol :class:`Electron`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lumos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">blist</span><span class="p">,</span> <span class="n">enes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="c1"># Find leftmost value greater than fermie.</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">find_gt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
                <span class="n">blist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">enes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>

            <span class="n">lumo_kidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">enes</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">lumo_band</span> <span class="o">=</span> <span class="n">blist</span><span class="p">[</span><span class="n">lumo_kidx</span><span class="p">]</span>

            <span class="c1"># Build Electron instance.</span>
            <span class="n">lumos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">lumo_kidx</span><span class="p">,</span> <span class="n">lumo_band</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lumos</span>

    <span class="c1">#def is_metal(self, spin)</span>
    <span class="c1">#    &quot;&quot;&quot;True if this spin channel is metallic.&quot;&quot;&quot;</span>
    <span class="c1">#    if not self.has_metallic_scheme: return False</span>
    <span class="c1">#    for k in self.kidxs:</span>
    <span class="c1">#        # Find leftmost value greater than x.</span>
    <span class="c1">#        b = find_gt(self.eigens[spin,k,:], self.fermie)</span>
    <span class="c1">#        if self.eigens[spin,k,b] &lt; self.fermie + 0.01:</span>
    <span class="c1">#            return True</span>

    <span class="c1">#def is_semimetal(self, spin)</span>
    <span class="c1">#    &quot;&quot;&quot;True if this spin channel is semi-metal.&quot;&quot;&quot;</span>
    <span class="c1">#    fun_gaps = self.fundamental_gaps</span>
    <span class="c1">#    for spin in self.spins:</span>
    <span class="c1">#       if abs(fun_gaps.ene) &lt;  TOL_EGAP</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="ElectronBands.bandwidths"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.bandwidths">[docs]</a>    <span class="k">def</span> <span class="nf">bandwidths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The bandwidth for each spin channel i.e. the energy difference (homo - lomo).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lomos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">eig</span> <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">]</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="ElectronBands.fundamental_gaps"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.fundamental_gaps">[docs]</a>    <span class="k">def</span> <span class="nf">fundamental_gaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of :class:`ElectronTransition` with info on the fundamental gaps for each spin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ElectronTransition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lumos</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span> <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">]</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="ElectronBands.direct_gaps"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.direct_gaps">[docs]</a>    <span class="k">def</span> <span class="nf">direct_gaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of :class:`ElectronTransition` with info on the direct gaps for each spin.&quot;&quot;&quot;</span>
        <span class="n">dirgaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">gaps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="n">homo_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">homo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">lumo_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lumo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">gaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lumo_sk</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">homo_sk</span><span class="o">.</span><span class="n">eig</span><span class="p">)</span>

            <span class="c1"># Find the index of the k-point where the direct gap is located.</span>
            <span class="n">kdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronTransition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kdir</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lumo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kdir</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dirgaps</span></div>

<div class="viewcode-block" id="ElectronBands.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_kpoints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Human-readable string with useful info such as band gaps, position of HOMO, LOMO...</span>

<span class="sd">        Args:</span>
<span class="sd">            with_structure: False if structural info shoud not be displayed.</span>
<span class="sd">            with_kpoints: False if k-point info shoud not be displayed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">with_structure</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of electrons: </span><span class="si">%s</span><span class="s2">, Fermi level: </span><span class="si">%.3f</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nsppol: </span><span class="si">%d</span><span class="s2">, nkpt: </span><span class="si">%d</span><span class="s2">, mband: </span><span class="si">%d</span><span class="s2">, nspinor: </span><span class="si">%s</span><span class="s2">, nspden: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_metallic_scheme</span><span class="p">:</span>
            <span class="n">enough_bands</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; For spin </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">enough_bands</span><span class="p">:</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Direct gap:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Fundamental gap:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Bandwidth: </span><span class="si">%.3f</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Valence minimum located at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lomos</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Valence max located at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_kpoints</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;K-points&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.spacing"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.spacing">[docs]</a>    <span class="k">def</span> <span class="nf">spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the statistical parameters of the energy spacing, i.e. e[b+1] - e[b]</span>

<span class="sd">        Returns:</span>
<span class="sd">            `namedtuple` with the statistical parameters in eV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ediff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:,:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>

        <span class="k">return</span> <span class="n">StatParams</span><span class="p">(</span>
            <span class="n">mean</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
            <span class="n">stdev</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
            <span class="nb">min</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
            <span class="nb">max</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span></div>

<div class="viewcode-block" id="ElectronBands.statdiff"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.statdiff">[docs]</a>    <span class="k">def</span> <span class="nf">statdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numpy_op</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the eigenenergies of two bands and compute the</span>
<span class="sd">        statistical parameters: mean, standard deviation, min and max</span>
<span class="sd">        The bands are aligned wrt to their fermi level.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: :class:`BandStructure` object.</span>
<span class="sd">            axis:  Axis along which the statistical parameters are computed.</span>
<span class="sd">                   The default is to compute the parameters of the flattened array.</span>
<span class="sd">            numpy_op: Numpy function to apply to the difference of the eigenvalues. The</span>
<span class="sd">                      default computes |self.eigens - other.eigens|.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `namedtuple` with the statistical parameters in eV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ediff</span> <span class="o">=</span> <span class="n">numpy_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">eigens</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">StatParams</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
                          <span class="n">stdev</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
                          <span class="nb">min</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
                          <span class="nb">max</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                          <span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.ipw_dos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.ipw_dos">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to compute the electron DOS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">def</span> <span class="nf">plot_dos</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
            <span class="n">edos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
            <span class="n">edos</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span>
                <span class="n">plot_dos</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;tetra&quot;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Step of linear mesh [eV]&quot;</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Gaussian broadening [eV]&quot;</span><span class="p">),</span>
                <span class="n">__manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.get_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_edos">[docs]</a>    <span class="k">def</span> <span class="nf">get_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the electronic DOS on a linear mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`ElectronDos` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Weights must be normalized to one.</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">sum_weights</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wsum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-6</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Kpoint weights should sum up to one while sum_weights is </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wsum</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;The list of kpoints does not represent a homogeneous sampling of the BZ</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">))</span> <span class="c1"># + &quot;\n&quot; + str(self.kpoints)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="c1"># Compute the linear mesh.</span>
        <span class="n">epad</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">width</span>
        <span class="n">e_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enemin</span><span class="p">()</span> <span class="o">-</span> <span class="n">epad</span>
        <span class="n">e_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enemax</span><span class="p">()</span> <span class="o">+</span> <span class="n">epad</span>

        <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>

        <span class="c1"># TODO: Write cython version.</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">weight</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]):</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                        <span class="n">dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="c1"># Use fermie from Abinit if we are not using metallic scheme for occopt.</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#if self.smearing[&quot;occopt&quot;] == 1:</span>
        <span class="c1">#    print(&quot;using fermie from GSR&quot;)</span>
        <span class="c1">#    fermie = self.fermie</span>
        <span class="n">edos</span> <span class="o">=</span> <span class="n">ElectronDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">)</span>
        <span class="c1">#print(&quot;ebands.fermie&quot;, self.fermie, &quot;edos.fermie&quot;, edos.fermie)</span>
        <span class="k">return</span> <span class="n">edos</span></div>

<div class="viewcode-block" id="ElectronBands.get_ejdos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_ejdos">[docs]</a>    <span class="k">def</span> <span class="nf">get_ejdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">valence</span><span class="p">,</span> <span class="n">conduction</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the join density of states at q == 0.</span>
<span class="sd">            :math:`\sum_{kbv} f_{vk} (1 - f_{ck}) \delta(\omega - E_{ck} + E_{vk})`</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            valence: Int or iterable with the valence indices.</span>
<span class="sd">            conduction: Int or iterable with the conduction indices.</span>
<span class="sd">            method: String defining the method.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            mesh: Frequency mesh to use. If None, the mesh is computed automatically from the eigenvalues.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`Function1D` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">sum_weights</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wsum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-6</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span>  <span class="s2">&quot;Kpoint weights should sum up to one while sum_weights is </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wsum</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;The list of kpoints does not represent a homogeneous sampling of the BZ</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valence</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">valence</span> <span class="o">=</span> <span class="p">[</span><span class="n">valence</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conduction</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">conduction</span> <span class="o">=</span> <span class="p">[</span><span class="n">conduction</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Compute the linear mesh.</span>
            <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conduction</span><span class="p">:</span>
                <span class="n">cmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">cmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valence</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="n">e_min</span> <span class="o">=</span> <span class="n">cmin</span> <span class="o">-</span> <span class="n">vmax</span>
            <span class="n">e_min</span> <span class="o">-=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e_min</span><span class="p">)</span>
            <span class="n">e_max</span> <span class="o">=</span> <span class="n">cmax</span> <span class="o">-</span> <span class="n">vmin</span>
            <span class="n">e_max</span> <span class="o">+=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e_max</span><span class="p">)</span>

            <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">jdos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nw</span><span class="p">)</span>

        <span class="c1"># Normalize the occupation factors.</span>
        <span class="n">full</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">weight</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conduction</span><span class="p">:</span>
                    <span class="n">ec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
                    <span class="n">fc</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">full</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valence</span><span class="p">:</span>
                        <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">]</span>
                        <span class="n">fv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">]</span> <span class="o">/</span> <span class="n">full</span>
                        <span class="n">fact</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">fv</span> <span class="o">*</span> <span class="n">fc</span>
                        <span class="n">jdos</span> <span class="o">+=</span> <span class="n">fact</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">ec</span><span class="o">-</span><span class="n">ev</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">jdos</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBands.plot_ejdosvc"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_ejdosvc">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ejdosvc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vrange</span><span class="p">,</span> <span class="n">crange</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the decomposition of the joint-density of States (JDOS).</span>

<span class="sd">        Args:</span>
<span class="sd">            vrange: Int or `Iterable` with the indices of the valence bands to consider.</span>
<span class="sd">            crange: Int or `Iterable` with the indices of the conduction bands to consider.</span>
<span class="sd">            method: String defining the method.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            cumulative: True for cumulative plots (default).</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crange</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">crange</span> <span class="o">=</span> <span class="p">[</span><span class="n">crange</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vrange</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">vrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">vrange</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [eV]&#39;</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># Get total JDOS for this spin</span>
            <span class="n">tot_jdos</span> <span class="o">=</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ejdos</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">vrange</span><span class="p">,</span> <span class="n">crange</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>

            <span class="c1"># Decomposition in terms of v --&gt; c transitions.</span>
            <span class="n">jdos_vc</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vrange</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">crange</span><span class="p">:</span>
                    <span class="n">jd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ejdos</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">tot_jdos</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
                    <span class="n">jdos_vc</span><span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">jd</span>

            <span class="c1"># Plot data for this spin.</span>
            <span class="k">if</span> <span class="n">cumulative</span><span class="p">:</span>
                <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tot_jdos</span><span class="p">))</span>
                <span class="n">num_plots</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jdos_vc</span><span class="p">),</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">jdos</span> <span class="ow">in</span> <span class="n">jdos_vc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">r&quot;$v=</span><span class="si">%s</span><span class="s2"> \rightarrow c=</span><span class="si">%s</span><span class="s2">, \sigma=</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">num_plots</span><span class="p">)</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">jdos</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">jdos</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">cumulative</span> <span class="o">+=</span> <span class="n">jdos</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_plots</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jdos_vc</span><span class="p">),</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">jdos</span> <span class="ow">in</span> <span class="n">jdos_vc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">num_plots</span><span class="p">)</span>
                    <span class="n">jdos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">r&quot;$v=</span><span class="si">%s</span><span class="s2"> \rightarrow c=</span><span class="si">%s</span><span class="s2">, \sigma=</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">tot_jdos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total JDOS, $\sigma=</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.apply_scissors"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.apply_scissors">[docs]</a>    <span class="k">def</span> <span class="nf">apply_scissors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scissors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify the band structure with the scissors operator.</span>

<span class="sd">        Args:</span>
<span class="sd">            scissors: An instance of :class:`Scissors`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            New instance of :class:`ElectronBands` with modified energies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scissors</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">scissors</span> <span class="o">=</span> <span class="p">[</span><span class="n">scissors</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scissors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expecting two scissors operators for spin up and down&quot;</span><span class="p">)</span>

        <span class="c1"># Create new array with same shape as self.</span>
        <span class="n">qp_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Calculate quasi-particle energies with the scissors operator.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">sciss</span> <span class="o">=</span> <span class="n">scissors</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">qp_ene</span> <span class="o">=</span> <span class="n">e0</span> <span class="o">+</span> <span class="n">sciss</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">sciss</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                        <span class="k">raise</span>

                    <span class="c1"># Update the energy.</span>
                    <span class="n">qp_energies</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">qp_ene</span>

        <span class="c1"># Apply the scissors to the Fermi level as well.</span>
        <span class="c1"># NB: This should be ok for semiconductors in which fermie == CBM (abinit convention)</span>
        <span class="c1"># and there&#39;s usually one CBM state whose QP correction is expected to be reproduced</span>
        <span class="c1"># almost exactly by the polyfit.</span>
        <span class="c1"># Not sure about metals. Besides occupations are not changed here!</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="n">scissors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="c1">#fermie = self.fermie</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KS fermie&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="s2">&quot;--&gt; QP fermie&quot;</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="s2">&quot;Delta(QP-KS)=&quot;</span><span class="p">,</span> <span class="n">fermie</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">qp_energies</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
            <span class="n">nband_sk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBands.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span>
             <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            klabels: dictionary whose keys are tuple with the reduced</span>
<span class="sd">                coordinates of the k-points. The values are the labels. e.g.</span>
<span class="sd">                klabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0):&quot;L&quot;}.</span>
<span class="sd">            band_range: Tuple specifying the minimum and maximum band to plot (default: all bands are plotted)</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            marker: String defining the marker to plot. Accepts the syntax `markername:fact` where</span>
<span class="sd">                fact is a float used to scale the marker size.</span>
<span class="sd">            width: String defining the width to plot. Accepts the syntax widthname:fact where</span>
<span class="sd">                fact is a float used to scale the stripe size.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select the band range.</span>
        <span class="k">if</span> <span class="n">band_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">band_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">band_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Decorate the axis (e.g add ticks and labels).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="n">klabels</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot the band energies.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_range</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

        <span class="c1"># Add markers to the plot.</span>
        <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">fact</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">marker</span>
                <span class="n">fact</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fact</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plot_marker_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">)</span>

        <span class="c1"># Plot fatbands.</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">fact</span> <span class="o">=</span> <span class="n">width</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">width</span>
                <span class="n">fact</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plot_width_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.decorate_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.decorate_ax">[docs]</a>    <span class="k">def</span> <span class="nf">decorate_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decoracte matplotlib Axis</span>

<span class="sd">        Accept:</span>
<span class="sd">            title:</span>
<span class="sd">            klabels</span>
<span class="sd">            klabel_size:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy [eV]&#39;</span><span class="p">)</span>

        <span class="c1"># Set ticks and labels.</span>
        <span class="n">klabels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;klabels&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="n">klabels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ticks</span><span class="p">:</span>
            <span class="c1"># Don&#39;t show label if previous k-point is the same.</span>
            <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">il</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">labels</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;klabel_size&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="ElectronBands.get_e0"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_e0">[docs]</a>    <span class="k">def</span> <span class="nf">get_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">e0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">e0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;fermie&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span>
            <span class="k">elif</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for e0: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume number</span>
            <span class="k">return</span> <span class="n">e0</span></div>

<div class="viewcode-block" id="ElectronBands.plot_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot the energies for (spin, band) on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: Matplotlib axis.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            spin: Spin index. If None, all spins are plotted.</span>
<span class="sd">            band: Band index, If None, all bands are plotted.</span>

<span class="sd">        Return matplotlib lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="n">band_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>

        <span class="c1"># Disable labels.</span>
        <span class="k">if</span> <span class="s2">&quot;label&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_no_legend_&quot;</span> <span class="c1"># Actively suppress.</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">),</span> <span class="p">[]</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_range</span><span class="p">:</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="ElectronBands.plot_width_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_width_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_width_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot fatbands for the given (spin,band) on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="n">band_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>

        <span class="n">facecolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;facecolor&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">),</span> <span class="n">fact</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_range</span><span class="p">:</span>
                <span class="n">y</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">width</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">fact</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.plot_marker_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_marker_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_marker_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot the markers on the axes ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">posneg_marker</span><span class="p">()</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

        <span class="c1"># Use different symbols depending on the value of s. Cannot use negative s.</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="n">fact</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; &gt;0&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">neg</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">neg</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">neg</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="n">fact</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; &lt;0&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_make_ticks_and_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klabels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ticks and labels from the mapping qlabels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">klabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">kcoord</span><span class="p">,</span> <span class="n">kname</span> <span class="ow">in</span> <span class="n">klabels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Build Kpoint instance.</span>
                <span class="n">ktick</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="p">(</span><span class="n">kcoord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ktick</span> <span class="o">==</span> <span class="n">kpt</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">kname</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_klabels</span>

        <span class="c1"># Return ticks, labels</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBands.plot_with_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_with_edos">[docs]</a>    <span class="k">def</span> <span class="nf">plot_with_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dos</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure and the DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            dos: An instance of :class:`ElectronDos`.</span>
<span class="sd">            klabels: dictionary whose keys are tuple with the reduced coordinates of the k-points.</span>
<span class="sd">                The values are the labels. e.g. `klabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0): &quot;L&quot;}`.</span>
<span class="sd">            axlist: The axes for the bandstructure plot and the DOS plot. If axlist is None, a new figure</span>
<span class="sd">                is created and the two axes are automatically generated.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See `edos_fermie`.</span>
<span class="sd">                - `edos_fermie`: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>

        <span class="k">if</span> <span class="n">axlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Build axes and align bands and DOS.</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take them from axlist.</span>
            <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">axlist</span>

        <span class="c1"># Define the zero of energy.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">dos</span><span class="o">.</span><span class="n">fermie</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

        <span class="c1"># Plot the band structure</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="n">klabels</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot the DOS</span>
        <span class="n">dos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.to_xmgrace"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_xmgrace">[docs]</a>    <span class="k">def</span> <span class="nf">to_xmgrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write xmgrace file with band structure energies and labels for high-symmetry k-points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">emef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Grace project file&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Generated by abipy on: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Crystalline structure:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# mband: </span><span class="si">%d</span><span class="s2">, nkpt: </span><span class="si">%d</span><span class="s2">, nsppol: </span><span class="si">%d</span><span class="s2">, nspinor: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# nelect: </span><span class="si">%8.2f</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Energies are in eV. Zero set to efermi, previously it was at: </span><span class="si">%s</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# List of k-points and their index (C notation i.e. count from 0)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
            <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">kpt</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page size 792, 612&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page scroll 5%&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page inout 5%&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@link page off&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@with g0&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@world xmin 0.00&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world xmax </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world ymin </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">emef</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world ymax </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">emef</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@default linewidth 1.5&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick on&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major 1&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major color 1&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major linestyle 3&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major grid on&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick spec type both&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major 0, 0&#39;</span><span class="p">)</span>

        <span class="n">kticks</span><span class="p">,</span> <span class="n">klabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick spec </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">kticks</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="p">(</span><span class="n">ktick</span><span class="p">,</span> <span class="n">klabel</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kticks</span><span class="p">,</span> <span class="n">klabels</span><span class="p">)):</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major </span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">ktick</span><span class="p">))</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  ticklabel </span><span class="si">%d</span><span class="s1">, &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">klabel</span><span class="p">))</span>

        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  ticklabel char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  tick major 10&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  label &quot;Band Energy [eV]&quot;&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  label char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  ticklabel char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">):</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@    s</span><span class="si">%d</span><span class="s1"> line color </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">spin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">ii</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">):</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@target G0.S</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@type xy&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">):</span>
                    <span class="n">w</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%.8E</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">emef</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">band</span><span class="p">]))</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ElectronBands.to_bxsf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_bxsf">[docs]</a>    <span class="k">def</span> <span class="nf">to_bxsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export the full band structure to `filepath` in BXSF format</span>
<span class="sd">        suitable for the visualization of the Fermi surface with Xcrysden (xcrysden --bxsf FILE).</span>
<span class="sd">        Require k-points in IBZ and gamma-centered k-mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sanity check.</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">eapp</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;The number of bands in nband must be constant&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_ibz</span><span class="p">:</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Expecting an IBZ sampling for the Fermi surface but got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_mpmesh</span><span class="p">:</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Monkhorst-Pack meshes are required for bxsf output.&quot;</span><span class="p">)</span>

        <span class="n">mpdivs</span><span class="p">,</span> <span class="n">shifts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">mpdivs_shifts</span>
        <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Gamma-centered k-meshes are required by Xcrysden.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

        <span class="c1"># Xcrysden requires points in the unit cell (C-order)</span>
        <span class="c1"># and the mesh must include the periodic images hence pbc=True.</span>
        <span class="n">bz2ibz</span> <span class="o">=</span> <span class="n">map_bz2ibz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">mpdivs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Construct bands in BZ: e_{TSk} = e_{k}</span>
        <span class="n">len_bz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bz2ibz</span><span class="p">)</span>
        <span class="n">emesh_sbk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="n">len_bz</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik_bz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_bz</span><span class="p">):</span>
            <span class="n">ik_ibz</span> <span class="o">=</span> <span class="n">bz2ibz</span><span class="p">[</span><span class="n">ik_bz</span><span class="p">]</span>
            <span class="n">emesh_sbk</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ik_bz</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="n">ik_ibz</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Write BXSF file.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">bxsf_write</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="n">mpdivs</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">emesh_sbk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.derivatives"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">asmarker</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the derivative of the eigenvalues wrt to k.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            band: Band index</span>
<span class="sd">            order:</span>
<span class="sd">            acc:</span>
<span class="sd">            asmarker:</span>

<span class="sd">        Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="c1"># Extract the branch.</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span>
            <span class="c1"># Simulate free-electron bands. This will produce all(effective masses == 1)</span>
            <span class="c1">#branch = 0.5 * units.Ha_to_eV * np.array([(k.norm * units.bohr_to_ang)**2 for k in self.kpoints])</span>

            <span class="c1"># Compute derivatives by finite differences.</span>
            <span class="n">ders_onlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">finite_diff</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">asmarker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
                    <span class="c1">#print(line)</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">branch</span><span class="p">[</span><span class="n">line</span><span class="p">])</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ders_onlines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="n">asmarker</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">ders_onlines</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Derivatives on homogeneous k-meshes are not supported yet&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.effective_masses"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.effective_masses">[docs]</a>    <span class="k">def</span> <span class="nf">effective_masses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the effective masses for the given `spin` and `band` index.</span>
<span class="sd">        Use finite difference with accuracy `acc`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy array of size nkpt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ders2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">eV_to_Ha</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">ders2</span></div>

<div class="viewcode-block" id="ElectronBands.effmass_line"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.effmass_line">[docs]</a>    <span class="k">def</span> <span class="nf">effmass_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the effective masses along a line. Requires band energies on a k-path.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: integer or class:`Kpoint` object. Note that if kpoint is not an integer,</span>
<span class="sd">                and the path contains duplicated k-points, the first k-point is selected.</span>
<span class="sd">            band: Band index.</span>
<span class="sd">            acc: accuracy</span>

<span class="sd">        Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;effmass_line requires a k-path.&quot;</span><span class="p">)</span>

        <span class="c1"># Find index associate to the k-point</span>
        <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>

        <span class="c1"># We have to understand if the k-point is a vertex or not.</span>
        <span class="c1"># If it&#39;s a vertex, indeed, we have to compute the left and right derivative</span>
        <span class="c1"># If kpt is inside the line, left and right derivatives are supposed to be equal</span>
        <span class="k">for</span> <span class="n">iline</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ik</span> <span class="o">&gt;=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find k-index </span><span class="si">%s</span><span class="s2"> in lines: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">))</span>

        <span class="n">kpos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
        <span class="n">is_inside</span> <span class="o">=</span> <span class="n">kpos</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">do_right</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_inside</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kpos</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="kn">from</span> <span class="nn">abipy.tools.derivatives</span> <span class="k">import</span> <span class="n">finite_diff</span>
        <span class="n">vals_on_line</span><span class="p">,</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">vers_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens_hvers_iline</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">iline</span><span class="p">)</span>
        <span class="n">d2line</span> <span class="o">=</span> <span class="n">finite_diff</span><span class="p">(</span><span class="n">vals_on_line</span><span class="p">,</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">eV_to_Ha</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">em_left</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">d2line</span><span class="p">[</span><span class="n">kpos</span><span class="p">]</span>
        <span class="n">em_right</span> <span class="o">=</span> <span class="n">em_left</span>
        <span class="n">h_right</span><span class="p">,</span> <span class="n">vers_right</span> <span class="o">=</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">vers_left</span>

        <span class="k">if</span> <span class="n">do_right</span><span class="p">:</span>
            <span class="n">kpos_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">kpos_right</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">vals_on_line</span><span class="p">,</span> <span class="n">h_right</span><span class="p">,</span> <span class="n">vers_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens_hvers_iline</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">iline</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">d2line</span> <span class="o">=</span> <span class="n">finite_diff</span><span class="p">(</span><span class="n">vals_on_line</span><span class="p">,</span> <span class="n">h_right</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">eV_to_Ha</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">em_right</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">d2line</span><span class="p">[</span><span class="n">kpos_right</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">EffectiveMassAlongLine</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">[</span><span class="n">ik</span><span class="p">],</span> <span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span>
                                      <span class="n">acc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span>
                                      <span class="n">is_inside</span><span class="p">,</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">vers_left</span><span class="p">,</span> <span class="n">em_left</span><span class="p">,</span> <span class="n">h_right</span><span class="p">,</span> <span class="n">vers_right</span><span class="p">,</span> <span class="n">em_right</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_eigens_hvers_iline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">iline</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
        <span class="n">vals_on_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For finite difference derivatives, the path must be homogeneous!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
        <span class="k">return</span> <span class="n">vals_on_line</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">versors</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<div class="viewcode-block" id="ElectronBands.interpolate"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpratio</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">vertices_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">kmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate energies in k-space along a k-path and, optionally, in the IBZ for DOS calculations.</span>
<span class="sd">        Note that the interpolation will likely fail if there are symmetrical k-points in the input sampling</span>
<span class="sd">        so it&#39;s recommended to call this method with band structure obtained in the IBZ.</span>

<span class="sd">        Args:</span>
<span class="sd">            lpratio: Ratio between the number of star functions and the number of ab-initio k-points.</span>
<span class="sd">                The default should be OK in many systems, larger values may be required for accurate derivatives.</span>
<span class="sd">            vertices_names: Used to specify the k-path for the interpolated band structure</span>
<span class="sd">                It&#39;s a list of tuple, each tuple is of the form (kfrac_coords, kname) where</span>
<span class="sd">                kfrac_coords are the reduced coordinates of the k-point and kname is a string with the name of</span>
<span class="sd">                the k-point. Each point represents a vertex of the k-path. `line_density` defines</span>
<span class="sd">                the density of the sampling. If None, the k-path is automatically generated according</span>
<span class="sd">                to the point group of the system.</span>
<span class="sd">            line_density: Number of points in the smallest segment of the k-path. Used with `vertices_names`.</span>
<span class="sd">            kmesh: Used to activate the interpolation on the homogeneous mesh for DOS (uses spglib API).</span>
<span class="sd">                kmesh is given by three integers and specifies mesh numbers along reciprocal primitive axis.</span>
<span class="sd">            is_shift: three integers (spglib API). When is_shift is not None, the kmesh is shifted along</span>
<span class="sd">                the axis in half of adjacent mesh points irrespective of the mesh numbers. None means unshited mesh.</span>
<span class="sd">            filter_params: TO BE described.</span>
<span class="sd">            verbose: Verbosity level</span>

<span class="sd">        Returns:</span>
<span class="sd">                namedtuple with the following attributes:</span>

<span class="sd">            ebands_kpath: :class:`ElectronBands` with the interpolated band structure on the k-path.</span>
<span class="sd">            ebands_kmesh: :class:`ElectronBands` with the interpolated band structure on the k-mesh.</span>
<span class="sd">                None if kmesh is not given.</span>
<span class="sd">            interpolator: :class:`SkwInterpolator` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get symmetries from abinit spacegroup (read from file).</span>
        <span class="n">abispg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span>
        <span class="k">if</span> <span class="n">abispg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fm_symrel</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">afm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abispg</span><span class="o">.</span><span class="n">symrel</span><span class="p">,</span> <span class="n">abispg</span><span class="o">.</span><span class="n">symafm</span><span class="p">)</span> <span class="k">if</span> <span class="n">afm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Ebands object does not have symmetry operations `spacegroup.symrel`</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;This usually happens when ebands has not been initalized from a netcdf file</span><span class="se">\n</span><span class="s2">.&quot;</span>
                   <span class="s2">&quot;Will call spglib to get symmetry operations.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">pymatgen.symmetry.analyzer</span> <span class="k">import</span> <span class="n">SpacegroupAnalyzer</span>
            <span class="n">spglib_data</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span><span class="o">.</span><span class="n">get_symmetry_dataset</span><span class="p">()</span>
            <span class="n">fm_symrel</span> <span class="o">=</span> <span class="n">spglib_data</span><span class="p">[</span><span class="s2">&quot;rotations&quot;</span><span class="p">]</span>

        <span class="c1"># Build interpolator.</span>
        <span class="kn">from</span> <span class="nn">abipy.core.skw</span> <span class="k">import</span> <span class="n">SkwInterpolator</span>
        <span class="n">my_kcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">)</span>

        <span class="n">skw</span> <span class="o">=</span> <span class="n">SkwInterpolator</span><span class="p">(</span><span class="n">lpratio</span><span class="p">,</span> <span class="n">my_kcoords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span>
                              <span class="n">cell</span><span class="p">,</span> <span class="n">fm_symrel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">,</span>
                              <span class="n">filter_params</span><span class="o">=</span><span class="n">filter_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Generate k-points for interpolation.</span>
        <span class="k">if</span> <span class="n">vertices_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vertices_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">hsym_kpoints</span><span class="p">]</span>
        <span class="n">kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="o">.</span><span class="n">from_vertices_and_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">vertices_names</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">)</span>
        <span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">knames</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">kpath</span><span class="o">.</span><span class="n">names</span>

        <span class="c1"># Interpolate energies.</span>
        <span class="n">eigens_kpath</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">eval_all</span><span class="p">(</span><span class="n">kfrac_coords</span><span class="p">)</span>

        <span class="c1"># Build new ebands object.</span>
        <span class="n">kpts_kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">knames</span><span class="p">)</span>
        <span class="n">occfacts_kpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eigens_kpath</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ebands_kpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpts_kpath</span><span class="p">,</span> <span class="n">eigens_kpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">occfacts_kpath</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">)</span>

        <span class="n">ebands_kmesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get kpts and weights in IBZ.</span>
            <span class="n">kdos</span> <span class="o">=</span> <span class="n">Ktables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kmesh</span><span class="p">,</span> <span class="n">is_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">)</span>
            <span class="n">eigens_kmesh</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">eval_all</span><span class="p">(</span><span class="n">kdos</span><span class="o">.</span><span class="n">ibz</span><span class="p">)</span>

            <span class="c1"># Build new ebands object with k-mesh</span>
            <span class="c1">#kptopt = kptopt_from_timrev()</span>
            <span class="n">ksampling</span> <span class="o">=</span> <span class="n">KSamplingInfo</span><span class="o">.</span><span class="n">from_mpdivs</span><span class="p">(</span><span class="n">mpdivs</span><span class="o">=</span><span class="n">kmesh</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">kpts_kmesh</span> <span class="o">=</span> <span class="n">IrredZone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">kdos</span><span class="o">.</span><span class="n">ibz</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">kdos</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
                                   <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="n">ksampling</span><span class="p">)</span>
            <span class="n">occfacts_kmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eigens_kmesh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ebands_kmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpts_kmesh</span><span class="p">,</span> <span class="n">eigens_kmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">occfacts_kmesh</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">ebands_kpath</span><span class="o">=</span><span class="n">ebands_kpath</span><span class="p">,</span> <span class="n">ebands_kmesh</span><span class="o">=</span><span class="n">ebands_kmesh</span><span class="p">,</span> <span class="n">interpolator</span><span class="o">=</span><span class="n">skw</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">EffectiveMassAlongLine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store the value of the effective mass computed along a line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">eig</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span>
                 <span class="n">is_inside</span><span class="p">,</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">vers_left</span><span class="p">,</span> <span class="n">em_left</span><span class="p">,</span> <span class="n">h_right</span><span class="p">,</span> <span class="n">vers_right</span><span class="p">,</span> <span class="n">em_right</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">eig</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_inside</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vers_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">em_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vers_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">em_right</span> <span class="o">=</span> \
            <span class="n">is_inside</span><span class="p">,</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">vers_left</span><span class="p">,</span> <span class="n">em_left</span><span class="p">,</span> <span class="n">h_right</span><span class="p">,</span> <span class="n">vers_right</span><span class="p">,</span> <span class="n">em_right</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;em_left: </span><span class="si">%s</span><span class="s2">, em_right: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">em_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">em_right</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Effective masses for spin: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%s</span><span class="s2">, accuracy: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">, eigenvalue: </span><span class="si">%s</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;h_left: </span><span class="si">%s</span><span class="s2">, h_right </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_right</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;is_inside: </span><span class="si">%s</span><span class="s2">, vers_left: </span><span class="si">%s</span><span class="s2">, vers_right: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_inside</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vers_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vers_right</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;em_left: </span><span class="si">%s</span><span class="s2">, em_right: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">em_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">em_right</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<div class="viewcode-block" id="frame_from_ebands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.frame_from_ebands">[docs]</a><span class="k">def</span> <span class="nf">frame_from_ebands</span><span class="p">(</span><span class="n">ebands_objects</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a pandas dataframe with the most important results available in a list of band structures.</span>

<span class="sd">    Args:</span>
<span class="sd">        struct_objects: List of objects that can be converted to structure.</span>
<span class="sd">            Support netcdf filenames or :class:`ElectronBands` objects</span>
<span class="sd">            See `ElectronBands.as_ebands` for the complete list.</span>
<span class="sd">        index: Index of the dataframe.</span>
<span class="sd">        with_spglib: If True, spglib is invoked to get the spacegroup symbol and number.</span>

<span class="sd">    Return:</span>
<span class="sd">        pandas :class:`DataFrame`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ebands_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ebands_objects</span><span class="p">]</span>
    <span class="c1"># Use OrderedDict to have columns ordered nicely.</span>
    <span class="n">odict_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_dict4frame</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">))</span> <span class="k">for</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="n">ebands_list</span><span class="p">]</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">odict_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">odict_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">odict_list</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="ElectronBandsPlotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter">[docs]</a><span class="k">class</span> <span class="nc">ElectronBandsPlotter</span><span class="p">(</span><span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting electronic band structure and DOSes.</span>
<span class="sd">    Supports plots on the same graph or separated plots.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = ElectronBandsPlotter()</span>
<span class="sd">        plotter.add_ebands(&quot;foo bands&quot;, &quot;foo.nc&quot;)</span>
<span class="sd">        plotter.add_ebands(&quot;bar bands&quot;, &quot;bar.nc&quot;)</span>
<span class="sd">        fig = plotter.gridplot()</span>

<span class="sd">    Dictionary with the mapping label --&gt; edos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_LINE_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,]</span>
    <span class="n">_LINE_STYLES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="s2">&quot;-.&quot;</span><span class="p">,]</span>
    <span class="n">_LINE_WIDTHS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ebands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key_edos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            key_ebands: List of (label, ebands) tuples.</span>
<span class="sd">                ebands is any object that can be converted into  :class:`ElectronBands` e.g. ncfile, path.</span>
<span class="sd">            key_edos: List of (label, edos) tuples.</span>
<span class="sd">                edos is any object that can be converted into :class:`ElectronDoc`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key_ebands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_ebands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_ebands</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_ebands</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_ebands</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_edos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_edos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_edos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_edos</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key_ebands</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key_ebands must be specifed when key_dos is not None&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_ebands</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_edos</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key_ebands and key_edos must have the same number of elements.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by repr&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ebands</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">edos</span><span class="p">)))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<div class="viewcode-block" id="ElectronBandsPlotter.get_ebands_frame"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.get_ebands_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_ebands_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a pandas dataframe with the most important results available in the band structures.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_from_ebands</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                 <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ebands_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;List of `:class:ElectronBands`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edoses_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;List of :class:`ElectronDos`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="ElectronBandsPlotter.iter_lineopt"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.iter_lineopt">[docs]</a>    <span class="k">def</span> <span class="nf">iter_lineopt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates style options for lines.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_WIDTHS</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_STYLES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_COLORS</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;add_ebands_from_file method of ElectronBandsPlotter has been replaced by add_ebands.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_ebands_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a band structure for plotting. Reads data from a Netcdfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">ebands</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">)</span>

<div class="viewcode-block" id="ElectronBandsPlotter.add_ebands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.add_ebands">[docs]</a>    <span class="k">def</span> <span class="nf">add_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">dos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a band structure and optionally a dos to the plotter.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: label for the bands. Must be unique.</span>
<span class="sd">            bands: :class:`ElectronBands` object.</span>
<span class="sd">            dos: :class:`ElectronDos` object.</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to `get_edos` to compute the electron DOS.</span>
<span class="sd">                Used only if `dos` is not None and it not an ElectronDos instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label </span><span class="si">%s</span><span class="s2"> is already in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">dos</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.bands_statdiff"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.bands_statdiff">[docs]</a>    <span class="k">def</span> <span class="nf">bands_statdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the reference bands with index ref with the other bands stored in the plotter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ref</span><span class="p">:</span>
                <span class="n">ref_label</span> <span class="o">=</span> <span class="n">label</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ref index </span><span class="si">%s</span><span class="s2"> is &gt; number of bands&quot;</span> <span class="o">%</span> <span class="n">ref</span><span class="p">)</span>

        <span class="n">ref_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">[</span><span class="n">ref_label</span><span class="p">]</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">bands</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">ref_label</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">ref_bands</span><span class="o">.</span><span class="n">statdiff</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBandsPlotter.combiplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.combiplot">[docs]</a>    <span class="k">def</span> <span class="nf">combiplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure and the DOS on the same figure.</span>
<span class="sd">        Use `gridplot` to plot band structures on different figures.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (ebands.fermie)</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See `edos_fermie`.</span>
<span class="sd">                - `edos_fermie`: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                   Available only if plotter contains dos objects.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="c1"># Build grid with two axes.</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="c1"># bands and DOS will share the y-axis</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># One axis for bands only</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_list</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot ebands.</span>
        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">my_kwargs</span><span class="p">,</span> <span class="n">opts_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">),</span> <span class="n">lineopt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_lineopt</span><span class="p">()):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">my_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lineopt</span><span class="p">)</span>
            <span class="n">opts_label</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Get energy zero.</span>
            <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;edos_fermie&quot;</span><span class="p">:</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">fermie</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

            <span class="n">l</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">my_kwargs</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Use relative paths if label is a file.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>

            <span class="c1"># Set ticks and labels, legends.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add DOSes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">edos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
                <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">opts_label</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;plot method of ElectronBandsPlotter has been replaced by combiplot.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;align&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s2">&quot;xlim&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s2">&quot;ylim&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;align|xlim|ylim options are not supported anymore.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBandsPlotter.gridplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.gridplot">[docs]</a>    <span class="k">def</span> <span class="nf">gridplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">with_dos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple electron bandstructures and optionally DOSes on a grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            eb_objects: List of objects from which the band structures are extracted.</span>
<span class="sd">                Each item in eb_objects is either a string with the path of the netcdf file,</span>
<span class="sd">                or one of the abipy object with an `ebands` attribute or a :class:`ElectronBands` object.</span>
<span class="sd">            edos_objects:</span>
<span class="sd">                List of objects from which the electron DOSes are extracted.</span>
<span class="sd">                Accept filepaths or :class:`ElectronDos` objects. If edos_objects is not None,</span>
<span class="sd">                each subplot in the grid contains a band structure with DOS else a simple bandstructure plot.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See `edos_fermie`.</span>
<span class="sd">                - `edos_fermie`: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                   Available only if edos_objects is not None</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_list</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">numeb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">numeb</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edos_list</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">with_dos</span><span class="p">:</span>
            <span class="c1"># Plot grid with bands only.</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
            <span class="k">if</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">,</span> <span class="n">axes</span><span class="p">)):</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plot grid with bands + DOS. see http://matplotlib.org/users/gridspec.html</span>
            <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span><span class="p">,</span> <span class="n">GridSpecFromSubplotSpec</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span><span class="p">)):</span>
                <span class="n">subgrid</span> <span class="o">=</span> <span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gspec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="c1"># Get axes and align bands and DOS.</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

                <span class="c1"># Define the zero of energy and plot</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot_with_edos</span><span class="p">(</span><span class="n">edos</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">mye0</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">):</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBandsPlotter.boxplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.boxplot">[docs]</a>    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">brange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn to draw a box plot to show distributions of eigenvalues with respect to the band index.</span>
<span class="sd">        Band structures are drawn on different subplots.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            brange: Only bands such as `brange[0] &lt;= band_index &lt; brange[1]` are included in the plot.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            kwargs: Keywork arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build grid of plots.</span>
        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span><span class="o">//</span><span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">ax_list</span><span class="p">):</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronBandsPlotter.combiboxplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.combiboxplot">[docs]</a>    <span class="k">def</span> <span class="nf">combiboxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">brange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn to draw a box plot comparing the distributions of the eigenvalues</span>
<span class="sd">        Band structures are drawn on the same plot.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>

<span class="sd">            brange: Only bands such as `brange[0] &lt;= band_index &lt; brange[1]` are included in the plot.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            kwargs: Keyword arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get the dataframe, select bands and add column with label</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">to_pdframe</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">brange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">brange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">brange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ebands</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Merge frames ignoring index (not meaningful)</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">seaborn.apionly</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spin_polarized</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;ax == None not implemented when nsppol==2&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">data_spin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spin</span><span class="p">]</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_spin</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_spin</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.animate"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.animate">[docs]</a>    <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">savefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use matplotlib to animate a list of band structure plots (with or without DOS).</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   See `edos_fermie`.</span>
<span class="sd">                - `edos_fermie`: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            interval: draws a new frame every interval milliseconds.</span>
<span class="sd">            savefile: Use e.g. &#39;myanimation.mp4&#39; to save the animation in mp4 format.</span>
<span class="sd">            show: True if the animation should be shown immediately</span>

<span class="sd">        Returns:</span>
<span class="sd">            Animation object.</span>

<span class="sd">        See also http://matplotlib.org/api/animation_api.html</span>
<span class="sd">                 http://jakevdp.github.io/blog/2012/08/18/matplotlib-animation-tutorial/</span>

<span class="sd">        Note:</span>
<span class="sd">            It would be nice to have the possibility of animating the title of the plot, unfortunately</span>
<span class="sd">            this feature is not available in the present version of matplotlib. See</span>
<span class="sd">            http://stackoverflow.com/questions/17558096/animated-title-in-matplotlib</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_list</span>
        <span class="k">if</span> <span class="n">edos_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">edos_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of objects for DOS must be equal to the number of bands&quot;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plotax_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

        <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edos_list</span><span class="p">:</span>
            <span class="c1"># Animation with band structures</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ebands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="c1">#if titles is not None:</span>
                <span class="c1">#    lines += [ax.set_title(titles[i])]</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Animation with band structures + DOS.</span>
            <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">ebands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span><span class="p">)):</span>
                <span class="c1"># Define the zero of energy to align bands and dos</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
                <span class="n">ebands_lines</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="n">edos_lines</span> <span class="o">=</span> <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">ebands_lines</span> <span class="o">+</span> <span class="n">edos_lines</span>
                <span class="c1">#if titles is not None:</span>
                <span class="c1">#    lines += [ax.set_title(titles[i])]</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>
        <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">artists</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                                         <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># True is faster but then the movie starts with an empty frame!</span>
                                         <span class="c1">#repeat_delay=1000</span>
                                         <span class="p">)</span>

        <span class="k">if</span> <span class="n">savefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">anim</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an ipython notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Use pickle files for data persistence. The notebook will reconstruct</span>
        <span class="c1"># the ebands and the edoses from this file by calling as_ebands, as_edos</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="n">key_ebands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
                <span class="n">key_ebands</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">))</span>

        <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">edos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">edos</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
                <span class="n">key_edos</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">))</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter = abilab.ElectronBandsPlotter(</span><span class="se">\n</span><span class="s2">key_ebands=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">key_edos=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">edos_kwargs=None)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key_ebands</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_edos</span><span class="p">))),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(plotter)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;frame = plotter.get_ebands_frame()</span><span class="se">\n</span><span class="s2">display(frame)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ylims = (None, None)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = plotter.gridplot(ylims=ylims)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = plotter.combiplot(ylims=ylims)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = plotter.boxplot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = plotter.combiboxplot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;if False: anim = plotter.animate()&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">ElectronsReader</span><span class="p">(</span><span class="n">ETSF_Reader</span><span class="p">,</span> <span class="n">KpointsReaderMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object reads band structure data from a netcdf file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">read_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an instance of :class:`ElectronBands`. Main entry point for client code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ElectronBands</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">(),</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_kpoints</span><span class="p">(),</span>
            <span class="n">eigens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_eigenvalues</span><span class="p">(),</span>
            <span class="n">fermie</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_fermie</span><span class="p">(),</span>
            <span class="n">occfacts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_occupations</span><span class="p">(),</span>
            <span class="n">nelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nelect</span><span class="p">(),</span>
            <span class="n">nspinor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nspinor</span><span class="p">(),</span>
            <span class="n">nspden</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nspden</span><span class="p">(),</span>
            <span class="n">nband_sk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nband_sk</span><span class="p">(),</span>
            <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_smearing</span><span class="p">(),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nband_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Array with the number of bands indexed by [s,k].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;number_of_states&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nspinor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of spinors.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;number_of_spinor_components&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nspden</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of spin-density components&quot;&quot;&quot;</span>
        <span class="c1"># FIXME: default 1 is needed for SIGRES files (abinit8)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;number_of_components&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_tsmear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;smearing_width&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_eigenvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eigenvalues in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">units</span><span class="o">.</span><span class="n">ArrayWithUnit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;eigenvalues&quot;</span><span class="p">),</span> <span class="s2">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_occupations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Occupancies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;occupations&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_fermie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fermi level in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">units</span><span class="o">.</span><span class="n">Energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;fermi_energy&quot;</span><span class="p">),</span> <span class="s2">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nelect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of valence electrons.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;number_of_electrons&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_smearing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a :class:`Smearing` instance with info on the smearing technique.&quot;&quot;&quot;</span>
        <span class="n">occopt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;occopt&quot;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;smearing_scheme&quot;</span><span class="p">))</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">Smearing</span><span class="p">(</span>
            <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span>
            <span class="n">occopt</span><span class="o">=</span><span class="n">occopt</span><span class="p">,</span>
            <span class="n">tsmear_ev</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">Energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;smearing_width&quot;</span><span class="p">),</span> <span class="s2">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<div class="viewcode-block" id="ElectronDos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos">[docs]</a><span class="k">class</span> <span class="nc">ElectronDos</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the electronic density of states.</span>
<span class="sd">    It is usually created by calling the get_edos method of :class:`ElectronBands`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_dos</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            mesh: array-like object with the mesh points.</span>
<span class="sd">            spin_dos: array-like object with the DOS value for the different spins.</span>
<span class="sd">                      spin_dos[1, nw] if spin-unpolarized.</span>
<span class="sd">                      spin_dos[2, nw] if spin-polarized case.</span>
<span class="sd">            nelect: Number of electrons in the unit cell.</span>
<span class="sd">            fermie: Fermi level in eV. If None, fermie is obtained from the idos.</span>

<span class="sd">        .. note::</span>

<span class="sd">            mesh is given in eV, spin_dos is in states/eV.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">spin_dos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_dos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">=</span> <span class="n">nelect</span>

        <span class="c1"># Save DOS and IDOS for each spin.</span>
        <span class="n">sumv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">spin_dos</span><span class="p">:</span>
            <span class="n">sumv</span> <span class="o">+=</span> <span class="n">values</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">integral</span><span class="p">())</span>

        <span class="c1"># Total DOS and IDOS.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">sumv</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sumv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_dos</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">sumv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_dos</span><span class="o">.</span><span class="n">integral</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fermie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fermie</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># *Compute* fermie from nelect. Note that this value could differ</span>
            <span class="c1"># from the one stored in ElectronBands (coming from the SCF run)</span>
            <span class="c1"># The accuracy of self.fermie depends on the number of k-points used for the DOS</span>
            <span class="c1"># and the parameters used to call ebands.get_edos.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_mu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tot_idos values:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nsppol=</span><span class="si">%d</span><span class="s2">, nelect=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Fermi energy: </span><span class="si">%s</span><span class="s2"> (recomputed from nelect):&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ElectronDos.as_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.as_edos">[docs]</a>    <span class="k">def</span> <span class="nf">as_edos</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of :class:`ElectronDos` from a generic obj.</span>
<span class="sd">        Supports:</span>

<span class="sd">            - instances of cls</span>
<span class="sd">            - files (string) that can be open with abiopen and that provide an `ebands` attribute.</span>
<span class="sd">            - objects providing an `ebands` or `get_edos` attribute</span>

<span class="sd">        Args:</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to `get_edos` to compute the electron DOS.</span>
<span class="sd">            Used when obj is not already an instance of `cls`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">edos_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">edos_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># path?</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pickle&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">edos_kwargs</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="k">import</span> <span class="n">abiopen</span>
            <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">as</span> <span class="n">abifile</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;ebands&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;get_edos&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to create `ElectronDos` from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">nsppol</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f1</span> <span class="o">!=</span> <span class="n">f2</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="ElectronDos.dos_idos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.dos_idos">[docs]</a>    <span class="k">def</span> <span class="nf">dos_idos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns DOS and IDOS for given spin. Total DOS and IDOS if spin is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_dos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span></div>

<div class="viewcode-block" id="ElectronDos.find_mu"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.find_mu">[docs]</a>    <span class="k">def</span> <span class="nf">find_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the chemical potential given the number of electrons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="c1"># Cannot use bisection because DOS might be negative due to smearing.</span>
        <span class="c1"># This one is safer albeit slower.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ene</span><span class="p">,</span> <span class="n">intg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">intg</span> <span class="o">&gt;</span> <span class="n">nelect</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find I(e) such that I(e) &gt; nelect&quot;</span><span class="p">)</span>

        <span class="c1"># Use linear interpolation to find mu (useful if mesh is coarse)</span>
        <span class="n">e0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">idos</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">e1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">idos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">e1</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">e0</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">nelect</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">/</span> <span class="n">alpha</span>
        <span class="c1">#print(&quot;idos[i-1]:&quot;, idos[i-1], &quot;idos[i]:&quot;, idos[i], &quot;intg&quot;, intg, &quot;nelect&quot;, nelect)</span>
        <span class="c1">#print(&quot;mu linear&quot;, mu)</span>
        <span class="k">return</span> <span class="n">mu</span></div>

<div class="viewcode-block" id="ElectronDos.get_e0"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.get_e0">[docs]</a>    <span class="k">def</span> <span class="nf">get_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">e0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">e0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;fermie&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span>
            <span class="k">elif</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for e0: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume number</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronDos.plot_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot the DOS data on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib axis.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            spin: selects the spin component, None for total DOS, IDOS.</span>
<span class="sd">            what: string selecting what will be plotted:</span>
<span class="sd">                  &quot;d&quot; for DOS, &quot;i&quot; for IDOS. chars can be concatenated</span>
<span class="sd">                  hence what=&quot;id&quot; plots both IDOS and DOS. (default &quot;d&quot;).</span>
<span class="sd">            fact: Multiplication factor for DOS/IDOS. Usually +-1 for spin DOS</span>
<span class="sd">            exchange_xy: True to exchange x-y axes.</span>
<span class="sd">            kwargs:</span>
<span class="sd">                Options passes to matplotlib.</span>

<span class="sd">        Return:</span>
<span class="sd">            list of lines added to the axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dosf</span><span class="p">,</span> <span class="n">idosf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dos_idos</span><span class="p">(</span><span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">)</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">what</span><span class="p">]</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">dosf</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">idosf</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">fact</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronDos.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot DOS</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            spin: Selects the spin component, None if total DOS is wanted.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            kwargs: options passed to ax.plot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [eV]&#39;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronDos.plot_dos_idos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot_dos_idos">[docs]</a>    <span class="k">def</span> <span class="nf">plot_dos_idos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot DOS and IDOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            spin: Selects the spin component, None if total DOS is wanted.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            kwargs: options passed to plot_ax</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>

        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TOT IDOS&quot;</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;IDOS (spin </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TOT DOS&quot;</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;DOS (spin </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [eV]&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronDos.plot_up_minus_down"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot_up_minus_down">[docs]</a>    <span class="k">def</span> <span class="nf">plot_up_minus_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot DOS</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            kwargs: options passed to ax.plot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># DOH!</span>
            <span class="n">dos_diff</span> <span class="o">=</span> <span class="n">Func1d</span><span class="o">.</span><span class="n">from_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dos_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">idos_diff</span><span class="o">=</span> <span class="n">dos_diff</span><span class="o">.</span><span class="n">integral</span><span class="p">()</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dos_diff</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">dos_diff</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">idos_diff</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">idos_diff</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [eV]&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="ElectronDosPlotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter">[docs]</a><span class="k">class</span> <span class="nc">ElectronDosPlotter</span><span class="p">(</span><span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting electronic DOSes.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = ElectronDosPlotter()</span>
<span class="sd">        plotter.add_edos(&quot;foo dos&quot;, &quot;foo.nc&quot;)</span>
<span class="sd">        plotter.add_edos(&quot;bar dos&quot;, &quot;bar.nc&quot;)</span>
<span class="sd">        fig = plotter.gridplot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#_LINE_COLORS = [&quot;b&quot;, &quot;r&quot;,]</span>
    <span class="c1">#_LINE_STYLES = [&quot;-&quot;,&quot;:&quot;,&quot;--&quot;,&quot;-.&quot;,]</span>
    <span class="c1">#_LINE_WIDTHS = [2,]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_edos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key_edos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_edos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_edos</span><span class="p">)</span>

    <span class="c1">#def iter_lineopt(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Generates style options for lines.&quot;&quot;&quot;</span>
    <span class="c1">#    for o in itertools.product( self._LINE_WIDTHS,  self._LINE_STYLES, self._LINE_COLORS):</span>
    <span class="c1">#        yield {&quot;linewidth&quot;: o[0], &quot;linestyle&quot;: o[1], &quot;color&quot;: o[2]}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edos_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of DOSes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;add_edos_from_file method of ElectronDosPlotter has been replaced by add_edos.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_edos_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a dos for plotting. Reads data from a Netcdf file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ebands</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">edos</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">label</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_edos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span>

<div class="viewcode-block" id="ElectronDosPlotter.add_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.add_edos">[docs]</a>    <span class="k">def</span> <span class="nf">add_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a DOS for plotting.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: label for the DOS. Must be unique.</span>
<span class="sd">            dos: :class:`ElectronDos` object.</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to `get_edos` to compute the electron DOS.</span>
<span class="sd">                Used only if `edos` is not an ElectronDos instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label </span><span class="si">%s</span><span class="s2"> is already in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">edos</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronDosPlotter.combiplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.combiplot">[docs]</a>    <span class="k">def</span> <span class="nf">combiplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the the DOSes on the same figure.</span>
<span class="sd">        Use `gridplot` to plot DOSes on different figures.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">dos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Use relative paths if label is a file.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">label</span><span class="p">):</span> <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">dos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy [eV]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;DOS [states/eV]&#39;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;plot method of ElectronDos has been replaced by combiplot.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="ElectronDosPlotter.gridplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.gridplot">[docs]</a>    <span class="k">def</span> <span class="nf">gridplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple DOSes on a grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See `edos_fermie`.</span>
<span class="sd">                - `edos_fermie`: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                   Available only if edos_objects is not None</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">edos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos_list</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">numeb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edos_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">numeb</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="c1"># Build Grid</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">edos</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronDosPlotter.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an ipython notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Use pickle files for data persistence. The notebook will reconstruct</span>
        <span class="c1"># the ebands and the edoses from this file by calling as_ebands, as_edos</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">edos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">edos</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
                <span class="n">key_edos</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">))</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;# This is a markdown cell&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter = abilab.ElectronDosPlotter(</span><span class="se">\n</span><span class="s2">key_edos=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">edos_kwargs=None)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key_edos</span><span class="p">))),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(plotter)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;xlims = (None, None)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = plotter.combiplot(xlims=xlims)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = plotter.gridplot(xlims=xlims)&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>

    <span class="c1">#def animate(self, **kwargs):</span>
    <span class="c1">#    animator = Animator()</span>
    <span class="c1">#    tmpdir = tempfile.mkdtemp()</span>
    <span class="c1">#    for (label, dos) in self.edoses_dict.items():</span>
    <span class="c1">#        savefig = os.path.join(tmpdir, label + &quot;.png&quot;)</span>
    <span class="c1">#        dos.plot(show=False, savefig=savefig)</span>
    <span class="c1">#        animator.add_figure(label, savefig)</span>
    <span class="c1">#    return animator.animate(**kwargs)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, The ABINIT group.
      Last updated on Mar 09, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>