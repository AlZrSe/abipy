

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Running calculations &mdash; abipy 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="abipy 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="User’s Guide" href="index.html"/>
        <link rel="next" title="What’s new in abipy" href="whats_new.html"/>
        <link rel="prev" title="abiopen" href="analyzing_results.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">User&#8217;s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_anaconda.html">How to use Anaconda to install Python and the most important dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_compile_python_and_bootstrap_pip.html">How to compile the Python interpreter and bootstrap <cite>pip</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="analyzing_results.html">abiopen</a></li>
<li class="toctree-l2"><a class="reference internal" href="analyzing_results.html#abistruct">abistruct</a></li>
<li class="toctree-l2"><a class="reference internal" href="analyzing_results.html#abicomp-py">abicomp.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="analyzing_results.html#abidoc-py">abidoc.py</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-configure-the-taskmanager">How to configure the TaskManager</a></li>
<li class="toctree-l3"><a class="reference internal" href="#taskmanager-for-a-personal-computer">TaskManager for a personal computer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-configure-the-scheduler">How to configure the scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-abipy-on-a-cluster">Configuring AbiPy on a cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="whats_new.html">What&#8217;s new in abipy</a></li>
<li class="toctree-l2"><a class="reference internal" href="license.html">License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Abipy Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">The AbiPy API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devel/index.html">The AbiPy Developers&#8217; Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">abipy</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">User&#8217;s Guide</a> &raquo;</li>
      
    <li>Running calculations</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/users/running_calculations.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="running-calculations">
<span id="id1"></span><h1>Running calculations<a class="headerlink" href="#running-calculations" title="Permalink to this headline">¶</a></h1>
<p>Besides post-processing tools and a programmatic interface to generate input files,
AbiPy also provides a pythonic interface to execute small Abinit tasks or submit calculations on supercomputing centers.
This section discusses how to create the configuration files required to interface AbiPy with Abinit.</p>
<p>We assume that Abinit is already available on your machine and that you know how to configure
your environment so that the operating system can load and execute code e.g.
set the <cite>$PATH</cite> and <cite>$LD_LIBRARY_PATH</cite> (<cite>DYLD_LIBRARY_PATH</cite> on Mac) environment variables,
load modules with <cite>module load</cite>, etc.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Please make sure that you can execute Abinit interactively with simple input files and
that the code works as expected before proceeding with the rest of the tutorial.</p>
</div>
<div class="section" id="how-to-configure-the-taskmanager">
<h2>How to configure the TaskManager<a class="headerlink" href="#how-to-configure-the-taskmanager" title="Permalink to this headline">¶</a></h2>
<p>The <cite>TaskManager</cite> is responsible for task submission
(creation of the submission script, initialization of the environment) as well as for the
optimization of the parameters used in parallel runs
(number of MPI processes, number of OpenMP threads, automatic parallelization with Abinit <cite>autoparal</cite> feature).</p>
<p>AbiPy knows how to run/submit the code with the correct environment and the appropriate syntax
thanks to the options given in the <cite>manager.yml</cite> configuration file.
The configuration file is written in <a class="reference external" href="https://en.wikipedia.org/wiki/YAML">YAML</a>,
a human-readable data serialization language commonly used for configuration files
(a good introduction to the YAML syntax can be found <a class="reference external" href="http://yaml.org/spec/1.1/#id857168">here</a>.
See also this <a class="reference external" href="http://www.yaml.org/refcard.html">reference card</a>)</p>
<p>By default, AbiPy looks for a <cite>manager.yml</cite> file in the current working directory i.e.
the directory in which you execute your script and then inside <cite>$HOME/.abinit/abipy</cite>.
If no <cite>manager.yml</cite> is found, the code aborts immediately.
Configuration files for typical cases are available in <cite>~abipy/data/managers</cite>.
We first discuss how to configure AbiPy on a personal computer and then we look at the more
complicated cases in which the calculation must be submitted to a queue.</p>
</div>
<div class="section" id="taskmanager-for-a-personal-computer">
<h2>TaskManager for a personal computer<a class="headerlink" href="#taskmanager-for-a-personal-computer" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s start from the simplest case i.e. a personal computer in which we can execute Abinit directly from the shell.
In this case, the configuration is relatively easy because we can execute the code
directly without having to submit a script to the resource manager to allocate resources (memory, MPI ranks, threads ...)
In its simplest form, the <cite>manager.yml</cite> consist of a list of <cite>qadapters</cite>
<cite>manager.yml</cite> contains a list of <cite>QueueAdapters</cite> objects.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">qadapters</span><span class="p p-Indicator">:</span>
    <span class="c1"># List of qadapters objects (mandatory)</span>
    <span class="p p-Indicator">-</span>  <span class="c1"># qadapter_1</span>
    <span class="p p-Indicator">-</span>  <span class="c1"># qadapter_2</span>
</pre></div>
</div>
<p>Each <cite>qadapter</cite> is essentially a dictionary with
Each <cite>QueueAdapter</cite> is responsible for all interactions with a specific queue management system (Slurm, PBS, bash, etc).
This includes handling all details of queue script format as well as queue submission and management.</p>
<p>The configuration file I use on my laptop is</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">qadapters</span><span class="p p-Indicator">:</span> <span class="c1"># List of `qadapters` objects  (just one in this simplified example)</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">qtype</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">shell</span>        <span class="c1"># &quot;Submit&quot; jobs via the shell.</span>
        <span class="l l-Scalar l-Scalar-Plain">qname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>    <span class="c1"># &quot;Submit&quot; to the `localhost` queue. (fake queue in this case)</span>

      <span class="l l-Scalar l-Scalar-Plain">priority</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>

      <span class="l l-Scalar l-Scalar-Plain">job</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">pre_run</span><span class="p p-Indicator">:</span> <span class="s">&quot;export</span><span class="nv"> </span><span class="s">PATH=$HOME/git_repos/abinit_eph/build_gcc/src/98_main:$PATH&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">mpi_runner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mpirun</span>

      <span class="l l-Scalar l-Scalar-Plain">limits</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">timelimit</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1:00:00</span>   <span class="c1">#  Time-limit for each task.</span>
        <span class="l l-Scalar l-Scalar-Plain">max_cores</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>         <span class="c1">#  Max number of cores that can be used by a single task.</span>

      <span class="c1"># Hardware specification, used by autoparal to optimize parallel execution.</span>
      <span class="l l-Scalar l-Scalar-Plain">hardware</span><span class="p p-Indicator">:</span>
         <span class="l l-Scalar l-Scalar-Plain">num_nodes</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
         <span class="l l-Scalar l-Scalar-Plain">sockets_per_node</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
         <span class="l l-Scalar l-Scalar-Plain">cores_per_socket</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
         <span class="l l-Scalar l-Scalar-Plain">mem_per_node</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4 Gb</span>
</pre></div>
</div>
<p>For the sake of brevity, we give a brief description of the meaning
of the different sections without entering into detail:</p>
<blockquote>
<div><ul>
<li><dl class="first docutils">
<dt>queue: dictionary with the name of the queue and optional parameters</dt>
<dd><p class="first last">used to build/customize the header of the submission script</p>
</dd>
</dl>
</li>
<li><p class="first">job: dictionary with the options used to prepare the environment before submitting the job</p>
</li>
<li><p class="first">limits: dictionary with the constraints that must be fulfilled in order to run with this queueadapter</p>
</li>
<li><p class="first">hardware: dictionary with information on the hardware available on this particular queue.</p>
</li>
</ul>
</div></blockquote>
<p>Use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">doc_manager</span>
</pre></div>
</div>
<p>to get the complete documentation of the <cite>manager.yml</cite> file</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ abirun.py doc_manager slurm
Traceback (most recent call last):
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/bin/abirun.py&quot;, line 4, in &lt;module&gt;
    __import__(&#39;pkg_resources&#39;).require(&#39;abipy==0.1.0&#39;)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2958, in &lt;module&gt;
    @_call_aside
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2944, in _call_aside
    f(*args, **kwargs)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2971, in _initialize_master_working_set
    working_set = WorkingSet._build_master()
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 635, in _build_master
    ws.require(__requires__)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 943, in require
    needed = self.resolve(parse_requirements(requirements))
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 829, in resolve
    raise DistributionNotFound(req, requirers)
pkg_resources.DistributionNotFound: The &#39;abipy==0.1.0&#39; distribution was not found and is required by the application
</pre></div>
</div>
<p>In this simple case, we have one <cite>QueueAdapter</cite> named <cite>gmac</cite> that will submit <cite>Tasks</cite>
in a shell subprocess (<cite>qtype: shell</cite>) with mpirun.
<cite>env.sh</cite> is the bash script I use to set the value of the environment variables
(e.g. <cite>PATH</cite> and <cite>LD_LIBRARY_PATH</cite>) before running ABINIT.</p>
<p>Note that my laptop has 1 socket with 2 CPUs and 4 Gb of memory in total, hence I don&#8217;t want
to run ABINIT tasks with more than 2 CPUs. This is the reason why <cite>max_cores</cite> is set to 2.
<cite>Timelimit</cite> is not used when you are using <cite>qname=shell</cite>, but it is very important when you
are submitting jobs on a cluster because this value is used to generate the submission script.</p>
<p>At this point, you may wonder why we need to specify all these parameters in the configuration file.
The reason is that, before submitting a job to a resource manager, <cite>AbiPy</cite> will use the autoparal
feature of ABINIT to get all the possible parallel configurations with <cite>ncpus &lt;= max_cores</cite>.
On the basis of these results, <cite>AbiPy</cite> selects the &#8220;optimal&#8221; one, and changes the ABINIT input file
and the submission script accordingly .
(this is a very useful feature, especially for calculations done with <cite>paral_kgb=1</cite> that require
the specification of <cite>npkpt</cite>, <cite>npfft</cite>, <cite>npband</cite>, etc).
If more than one <cite>QueueAdapter</cite> is specified, <cite>AbiPy</cite> will first compute all the possible
configuration and then select the &#8220;optimal&#8221; <cite>QueueAdapter</cite> according to some kind of policy</p>
<p>Copy this example, change the entries in the <cite>hardware</cite> and the <cite>limits</cite> section according to
your machine, change <cite>pre_run</cite> so that the Abinit executables can be found in <cite>$PATH</cite>.
Save the file in the current working directory and run <cite>abicheck.py</cite>.
If everything is configured properly, you should see something like this in the terminal.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ abicheck.py --no-colors
Traceback (most recent call last):
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/bin/abicheck.py&quot;, line 4, in &lt;module&gt;
    __import__(&#39;pkg_resources&#39;).require(&#39;abipy==0.1.0&#39;)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2958, in &lt;module&gt;
    @_call_aside
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2944, in _call_aside
    f(*args, **kwargs)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2971, in _initialize_master_working_set
    working_set = WorkingSet._build_master()
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 635, in _build_master
    ws.require(__requires__)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 943, in require
    needed = self.resolve(parse_requirements(requirements))
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 829, in resolve
    raise DistributionNotFound(req, requirers)
pkg_resources.DistributionNotFound: The &#39;abipy==0.1.0&#39; distribution was not found and is required by the application
</pre></div>
</div>
<p>This message tells us that everything is in place and we can finally run our first calculation with Abipy.
The directory <cite>abipy/data/runs</cite> contains python scripts to generate workflows for typical ab-initio calculations.
Here we focus on the configuration of the manager and the execution of the flow so we don&#8217;t to explain how to
generate input files and create Flow objects in python.</p>
<p>Let&#8217;s start from the simplest example i.e. the <cite>run_si_ebands.py</cite> script that generates
a flow to compute the band structure of silicon at the Kohn-Sham level
(GS calculation to get the density followed by a NSCF run along a k-path in the first Brillouin zone).
Cd to ~abipy/data/runs and execute <cite>run_si_ebands.py</cite> to generate the flow:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~</span><span class="n">abipy</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">runs</span>
<span class="o">./</span><span class="n">run_si_ebands</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>At this point, you should have a directory named <cite>flow_si_ebands</cite> with the following structure:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> tree flow_si_ebands/

<span class="go">flow_si_ebands/</span>
<span class="go">├── __AbinitFlow__.pickle</span>
<span class="go">├── indata</span>
<span class="go">├── outdata</span>
<span class="go">├── tmpdata</span>
<span class="go">└── w0</span>
<span class="go">    ├── indata</span>
<span class="go">    ├── outdata</span>
<span class="go">    ├── t0</span>
<span class="go">    │   ├── indata</span>
<span class="go">    │   ├── job.sh</span>
<span class="go">    │   ├── outdata</span>
<span class="go">    │   ├── run.abi</span>
<span class="go">    │   ├── run.files</span>
<span class="go">    │   └── tmpdata</span>
<span class="go">    ├── t1</span>
<span class="go">    │   ├── indata</span>
<span class="go">    │   ├── job.sh</span>
<span class="go">    │   ├── outdata</span>
<span class="go">    │   ├── run.abi</span>
<span class="go">    │   ├── run.files</span>
<span class="go">    │   └── tmpdata</span>
<span class="go">    └── tmpdata</span>

<span class="go">15 directories, 7 files</span>
</pre></div>
</div>
<p><cite>w0</cite> is the directory containing the input files of the first workflow (well, we have only one workflow in our example).
<cite>w0/t0</cite> and <cite>w0/t1</cite> contain the input files need to run the SCF and the NSC run, respectively.</p>
<p>You might have noticed that each <cite>Task</cite> directory (<cite>w0/t0</cite>, <cite>w0/t1</cite>) presents the same structure:</p>
<blockquote>
<div><ul class="simple">
<li>run.abi: Abinit input file</li>
<li>run.files: Abinit files file</li>
<li>job.sh: Submission/shell script</li>
<li>outdata: Directory with output data files</li>
<li>indata: Directory with input data files</li>
<li>tmpdata: Directory with temporary files</li>
</ul>
</div></blockquote>
<div class="admonition danger">
<p class="first admonition-title">Danger</p>
<p class="last"><cite>__AbinitFlow__.pickle</cite> is the pickle file used to save the status of the <cite>Flow</cite>. Don&#8217;t touch it!</p>
</div>
<p>The <cite>job.sh</cite> has been generated using the information provided by <cite>manager.yml</cite>.
In this case it&#8217;s a simple shell script that executes the code but this is normal because we are using <cite>qtype: shell</cite>.
The script will be more complicated when we start to submit jobs on a cluster with a resource manager.</p>
<p>We usually interact with the Abipy flow via the <cite>abirun.py</cite> script.
The script uses the syntax:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>`abirun.py FLOWDIR command [options]`
</pre></div>
</div>
<p>where <cite>FLOWDIR</cite> is the directory containing the flow and <cite>command</cite> defines the action to perform
(use <cite>&#8211;help</cite> to get the list of possible commands).
<cite>abirun.py</cite> reconstruct the python Flow from the pickle file <cite>__AbinitFlow__.pickle</cite> located in <cite>FLOWDIR</cite>
and invokes the methods of the object depending on the options specified by the user on the command line.
Let&#8217;s start to play with our flow.</p>
<p>Use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">flow_si_ebands</span> <span class="n">status</span>
</pre></div>
</div>
<p>to have a summary with the status of the different tasks and:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">flow_si_ebands</span> <span class="n">deps</span>
</pre></div>
</div>
<p>to print the interconnection among the tasks in text format.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">&lt;ScfTask, node_id=75244, workdir=flow_si_ebands/w0/t0&gt;</span>

<span class="go">&lt;NscfTask, node_id=75245, workdir=flow_si_ebands/w0/t1&gt;</span>
<span class="go">  +--&lt;ScfTask, node_id=75244, workdir=flow_si_ebands/w0/t0&gt;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Alternatively one can use <cite>abirun.py flow_si_ebands/ networkx</cite>
to visualize the connections with the <cite>networkx</cite> package.</p>
</div>
<p>In this case, we have a flow with two tasks and the second task (<cite>w0/t1</cite>)
depends on the <cite>ScfTask</cite>, more specifically on the density file produced by it.
This means that the second task cannot be executed/submitted until we have completed the first task.
<cite>abirun.py</cite> knows the dependencies of our flow and will use this information to manage the submission/execution
of our tasks.</p>
<p>There are two commands that can be used to launch tasks: <cite>single</cite> and <cite>rapid</cite>.
The <cite>single</cite> command execute the first <cite>Task</cite> in the flow that is in the <cite>READY</cite> state that is a task
whose dependencies have been fulfilled while <cite>rapid</cite> submits all task of the flow that are in the <cite>READY</cite> state.
Let&#8217;s try to run the flow with the <cite>rapid</cite> command and see what happens.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">abirun.py flow_si_ebands rapid</span>

<span class="go">Running on gmac2 -- system Darwin -- Python 2.7.12 -- abirun-0.1.0</span>
<span class="go">Number of tasks launched: 1</span>

<span class="go">Work #0: &lt;BandStructureWork, node_id=75239, workdir=flow_si_ebands/w0&gt;, Finalized=False</span>
<span class="go">+--------+-------------+-----------------+--------------+------------+----------+-----------------+----------+-----------+</span>
<span class="go">| Task   | Status      | Queue           | MPI|Omp|Gb   | Warn|Com   | Class    | Sub|Rest|Corr   | Time     |   Node_ID |</span>
<span class="go">+========+=============+=================+==============+============+==========+=================+==========+===========+</span>
<span class="go">| w0_t0  | Submitted   | 71573@localhost | 2|  1|2.0    | 1|  0      | ScfTask  | (1, 0, 0)       | 0:00:00Q |     75240 |</span>
<span class="go">+--------+-------------+-----------------+--------------+------------+----------+-----------------+----------+-----------+</span>
<span class="go">| w0_t1  | Initialized | None            | 1|  1|2.0    | NA|NA      | NscfTask | (0, 0, 0)       | None     |     75241 |</span>
<span class="go">+--------+-------------+-----------------+--------------+------------+----------+-----------------+----------+-----------+</span>
</pre></div>
</div>
<p>What&#8217;s happening here?
The <cite>rapid</cite> command tried to execute all tasks that are <cite>READY</cite> but since the second task depends on the first
one only the first task gets submitted.
Note that the SCF task (<cite>w0_t0</cite>) has been submitted with 2 MPI processors.
Before submitting the task, indeed, AbiPy
invokes Abinit to get all the possible parallel configurations compatible with the constrains specified by the user,
select the &#8220;optimal&#8221; configuration according to some policy and submit the task with the optimized parameters.
At this point, there&#8217;s no other task that can be executed, the script exits
and we have to wait for the SCF task before running the second part of the flow.</p>
<p>At each iteration, <cite>abirun.py</cite> prints a table with the status of the different tasks.
The meaning of the columns is as follows:</p>
<blockquote>
<div><ul>
<li><p class="first">Queue: JobID &#64; QueueName (JobID == Process identifier if shell, job ID if we are submitting to QueueName)</p>
</li>
<li><p class="first">MPI: Number of MPI processes used (computed automatically with autoparal, cannot exceed max_ncpus)</p>
</li>
<li><p class="first">OMP: Number of OpenMP threads.</p>
</li>
<li><p class="first">Gb: Memory requested in Gb (meaningless in this case because we&#8217;re using the shell).</p>
</li>
<li><p class="first">Warn: Number of warning messages found in the log file.</p>
</li>
<li><p class="first">Com: Number of comments found in the log file.</p>
</li>
<li><dl class="first docutils">
<dt>Sub: Number of submissions (can be &gt; 1 if Abipy encounters a problem and resubmit the task with different parameters</dt>
<dd><p class="first last">without performing any operation that can change the physics of the system).</p>
</dd>
</dl>
</li>
<li><p class="first">Rest: Number of restarts (Abipy can restart the job if convergence has not been reached)</p>
</li>
<li><p class="first">Corr: Number of corrections performed. These operations can change the physics of the system.</p>
</li>
<li><p class="first">Time: Time spent in the Queue (if ends with Q) or running time (if ends with R).</p>
</li>
<li><p class="first">Node_ID: Node identifier used by Abipy to identify each node of the flow.</p>
</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the submission is done through the shell there&#8217;s almost no difference between
job submission and job execution. The scenario is completely different if you are submitting
jobs to a resource manager because the task will get a priority value and will enter the queue.</p>
</div>
<p>If you execute <cite>status</cite> again, you should see that the first task is completed.
We can thus run <cite>rapidfire</cite> again to launch the <cite>NscfTask</cite>.
The second task won&#8217;t take long and if you issue <cite>status</cite> again, you should see that the entire flow
completed successfully.</p>
<p>To understand what happened in more detail, use the <cite>history</cite> command to get the list of operations
performed by AbiPy on each task.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> abirun.py flow_si_ebands <span class="nb">history</span>

<span class="go">==============================================================================================================================</span>
<span class="go">=================================== &lt;ScfTask, node_id=75244, workdir=flow_si_ebands/w0/t0&gt; ===================================</span>
<span class="go">==============================================================================================================================</span>
<span class="go">[Mon Mar  6 21:46:00 2017] Status changed to Ready. msg: Status set to Ready</span>
<span class="go">[Mon Mar  6 21:46:00 2017] Setting input variables: {&#39;max_ncpus&#39;: 2, &#39;autoparal&#39;: 1}</span>
<span class="go">[Mon Mar  6 21:46:00 2017] Old values: {&#39;max_ncpus&#39;: None, &#39;autoparal&#39;: None}</span>
<span class="go">[Mon Mar  6 21:46:00 2017] Setting input variables: {&#39;npband&#39;: 1, &#39;bandpp&#39;: 1, &#39;npimage&#39;: 1, &#39;npspinor&#39;: 1, &#39;npfft&#39;: 1, &#39;npkpt&#39;: 2}</span>
<span class="go">[Mon Mar  6 21:46:00 2017] Old values: {&#39;npband&#39;: None, &#39;npfft&#39;: None, &#39;npkpt&#39;: None, &#39;npimage&#39;: None, &#39;npspinor&#39;: None, &#39;bandpp&#39;: None}</span>
<span class="go">[Mon Mar  6 21:46:00 2017] Status changed to Initialized. msg: finished autoparallel run</span>
<span class="go">[Mon Mar  6 21:46:00 2017] Submitted with MPI=2, Omp=1, Memproc=2.0 [Gb] submitted to queue</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Task completed status set to ok based on abiout</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Finalized set to True</span>

<span class="go">=============================================================================================================================</span>
<span class="go">================================== &lt;NscfTask, node_id=75245, workdir=flow_si_ebands/w0/t1&gt; ==================================</span>
<span class="go">=============================================================================================================================</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Status changed to Ready. msg: Status set to Ready</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Adding connecting vars {u&#39;irdden&#39;: 1}</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Setting input variables: {u&#39;irdden&#39;: 1}</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Old values: {u&#39;irdden&#39;: None}</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Setting input variables: {&#39;max_ncpus&#39;: 2, &#39;autoparal&#39;: 1}</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Old values: {&#39;max_ncpus&#39;: None, &#39;autoparal&#39;: None}</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Setting input variables: {&#39;npband&#39;: 1, &#39;bandpp&#39;: 1, &#39;npimage&#39;: 1, &#39;npspinor&#39;: 1, &#39;npfft&#39;: 1, &#39;npkpt&#39;: 2}</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Old values: {&#39;npband&#39;: None, &#39;npfft&#39;: None, &#39;npkpt&#39;: None, &#39;npimage&#39;: None, &#39;npspinor&#39;: None, &#39;bandpp&#39;: None}</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Status changed to Initialized. msg: finished autoparallel run</span>
<span class="go">[Mon Mar  6 21:46:15 2017] Submitted with MPI=2, Omp=1, Memproc=2.0 [Gb] submitted to queue</span>
<span class="go">[Mon Mar  6 21:49:48 2017] Task completed status set to ok based on abiout</span>
<span class="go">[Mon Mar  6 21:49:48 2017] Finalized set to True</span>
</pre></div>
</div>
<p>A closer inspection of the logs reveal that before submitting the first task, <cite>abirun.py</cite> has executed
Abinit in <cite>autoparal</cite> mode to get the list of possible parallel configuration and the calculation is then submitted.
At this point, <cite>abirun.py</cite> starts to look at the output files produced by the task to understand  what&#8217;s happening.
When the first task reaches completion, the second task is automatically changed to READY,
the <cite>irdden</cite> input variable is added to the input file of the second task and a symbolic link to
the DEN file produced by the first task is created in the <cite>indata</cite> directory of the second task.
Another <cite>autoparallel run</cite> is now executed and the second task is finally submitted.</p>
<p>The command line interface is very flexible and sometimes it&#8217;s the only tool available.
However, there are cases in which we would like to have a global view of what&#8217;s happening
The command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">flow_si_ebands</span> <span class="n">notebook</span>
</pre></div>
</div>
<p>generates a <cite>jupyter</cite> notebook with pre-defined calls that can be executed
in order to get a graphical representation of the status of our flow inside a web browser
(requires <cite>jupyter</cite>, <cite>nbformat</cite> and, obviously, a web browser).
Expert users may want to use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">flow_si_ebands</span> <span class="n">ipython</span>
</pre></div>
</div>
<p>to open the <cite>flow</cite> in the <cite>ipython</cite> terminal to have direct access to the API provided by the object.</p>
</div>
<div class="section" id="how-to-configure-the-scheduler">
<h2>How to configure the scheduler<a class="headerlink" href="#how-to-configure-the-scheduler" title="Permalink to this headline">¶</a></h2>
<p>In the previous example, we ran a simple band structure calculation for silicon in a few seconds
on a laptop but one might have more complicated flows requiring hours or even days to complete.
For such cases, the <cite>single</cite> and <cite>rapid</cite> commands are not handy because we are supposed
to monitor the evolution of the flow and re-run <cite>abirun.py</cite> when a new task is <cite>READY</cite>.
In these cases, it is much easier to delegate all the repetitive work to a python scheduler,
a sort of job that runs in the background and submits tasks automatically and perform the actions
required to complete the flow.</p>
<p>The parameters for the scheduler are declared in the YAML file <cite>scheduler.yml</cite>.
Also in this case, AbiPy will look first in the working directory and then inside <cite>$HOME/.abinit/abipy</cite>.
Crate a <cite>scheduler.yml</cite> in the working directory by copying the example below:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">seconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>  <span class="c1"># number of seconds to wait.</span>
<span class="c1">#minutes: 0  # number of minutes to wait.</span>
<span class="c1">#hours: 0    # number of hours to wait.</span>
<span class="c1">#days: 0     # number of days to wait.</span>
</pre></div>
</div>
<p>This file tells the scheduler to wake up every 10 seconds, inspect the status of the tasks
in the flow and perform the actions required for reach completion</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Remember to set the time interval of the scheduler to a reasonable value.
A small value leads to an increase of the submission rate but it also increases the CPU load
and the pressure on the hardware and on the resource manager.
A too large time interval can have a detrimental effect on the throughput, especially
if you are submitting many small jobs.</p>
</div>
<p>At this point, we are ready to run our first calculation with the scheduler.
To make things more interesting, we execute a slightly more complicated flow that computes
the G0W0 corrections to the direct band gap of silicon at the Gamma point.
The flow consists of the following six tasks:</p>
<blockquote>
<div><p>1: ground state calculation to get the density
2: NSCF calculation with several empty states.
3: calculation of the screening using the WFK produced by task 2
4-5-6: Evaluation of the Self-Energy matrix elements with different values of nband</p>
<blockquote>
<div>using the WFK produced by task 2 and the SCR file produced by task 3</div></blockquote>
</div></blockquote>
<p>Generate the flow with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">run_si_g0w0</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>and let the scheduler manage the task submission with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">flow_si_g0w0</span> <span class="n">scheduler</span>
</pre></div>
</div>
<p>You should see the following output on the terminal</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">abirun.py flow_si_ebands scheduler</span>

<span class="go">Abipy Scheduler:</span>
<span class="go">PyFlowScheduler, Pid: 72038</span>
<span class="go">Scheduler options: {&#39;seconds&#39;: 10, &#39;hours&#39;: 0, &#39;weeks&#39;: 0, &#39;minutes&#39;: 0, &#39;days&#39;: 0}</span>
</pre></div>
</div>
<p>PID is the process identifier of the scheduler (also reported in the ... file)
We will see that the scheduler PID is extremely important when we start to run large flows on clusters.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Note that there must be only one scheduler associated to a given flow.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Use <cite>abirun.py . doc_scheduler</cite> to get the full list of options supported by the scheduler.</p>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ abirun.py doc_scheduler
Traceback (most recent call last):
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/bin/abirun.py&quot;, line 4, in &lt;module&gt;
    __import__(&#39;pkg_resources&#39;).require(&#39;abipy==0.1.0&#39;)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2958, in &lt;module&gt;
    @_call_aside
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2944, in _call_aside
    f(*args, **kwargs)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2971, in _initialize_master_working_set
    working_set = WorkingSet._build_master()
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 635, in _build_master
    ws.require(__requires__)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 943, in require
    needed = self.resolve(parse_requirements(requirements))
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 829, in resolve
    raise DistributionNotFound(req, requirers)
pkg_resources.DistributionNotFound: The &#39;abipy==0.1.0&#39; distribution was not found and is required by the application
</pre></div>
</div>
</div>
<div class="section" id="configuring-abipy-on-a-cluster">
<h2>Configuring AbiPy on a cluster<a class="headerlink" href="#configuring-abipy-on-a-cluster" title="Permalink to this headline">¶</a></h2>
<p>In this section we discuss how to configure the manager to run flows on a cluster.
The configuration depends on specific queue management system (Slurm, PBS, etc) so
we assume that you are already familiar with job submissions and you know the options
that mush be specified in the job script in order to have your submission accepted
by the management system (username, name of the queue ...)</p>
<p>Let&#8217;s assume that your computing center uses Slurm and your jobs must be submitted to the <cite>Oban</cite> partition
A <cite>manager.yml</cite> with a single <cite>qadapter</cite> will look like:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># Resource manager e.g slurm, pbs, shell</span>
<span class="l l-Scalar l-Scalar-Plain">qtype</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">slurm</span>

<span class="c1"># Options passed to the resource manager</span>
<span class="c1"># (the syntax depends on qtype, consult the manual of your resource manager)</span>
<span class="l l-Scalar l-Scalar-Plain">qparams</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">ntasks</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="l l-Scalar l-Scalar-Plain">time</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0:20:00</span>
  <span class="l l-Scalar l-Scalar-Plain">partition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Oban</span>

<span class="c1"># List of modules to import before running the calculation</span>
<span class="l l-Scalar l-Scalar-Plain">modules</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">intel/compilerpro/13.0.1.117</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">fftw3/intel/3.3</span>

<span class="l l-Scalar l-Scalar-Plain">mpi_runner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/mpirun</span>

<span class="c1"># Shell environment</span>
<span class="l l-Scalar l-Scalar-Plain">shell_env</span><span class="p p-Indicator">:</span>
     <span class="l l-Scalar l-Scalar-Plain">PATH</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/home/user/local/bin/:$PATH</span>
     <span class="l l-Scalar l-Scalar-Plain">LD_LIBRARY_PATH</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/home/user/local/lib:$LD_LIBRARY_PATH</span>

<span class="c1"># Options for the automatic parallelization (Abinit autoparal feature)</span>
<span class="l l-Scalar l-Scalar-Plain">policy</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">autoparal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="l l-Scalar l-Scalar-Plain">max_ncpus</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
</pre></div>
</div>
<p>Description:</p>
<p><cite>qtype</cite> specifies the queue resource manager. This option tells Abipy how to generate submission
scripts, submit them, kill jobs in the queue and how to interpret the other options passed by the user.</p>
<dl class="docutils">
<dt><cite>qparams</cite> is a dictionary with the parameters passed to the resource manager.</dt>
<dd>We use the <em>normalized</em> version of the options i.e dashes in the official name of the parameter
are replaced by underscores  (for the list of supported options see ...)</dd>
</dl>
<p>The complete list of options (<cite>qparams</cite>) supported by the <cite>TaskManager</cite> with Slurm  can be obtained with</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ abirun.py . doc_manager slurm
Traceback (most recent call last):
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/bin/abirun.py&quot;, line 4, in &lt;module&gt;
    __import__(&#39;pkg_resources&#39;).require(&#39;abipy==0.1.0&#39;)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2958, in &lt;module&gt;
    @_call_aside
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2944, in _call_aside
    f(*args, **kwargs)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2971, in _initialize_master_working_set
    working_set = WorkingSet._build_master()
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 635, in _build_master
    ws.require(__requires__)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 943, in require
    needed = self.resolve(parse_requirements(requirements))
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 829, in resolve
    raise DistributionNotFound(req, requirers)
pkg_resources.DistributionNotFound: The &#39;abipy==0.1.0&#39; distribution was not found and is required by the application
</pre></div>
</div>
<p><cite>modules</cite> is the list of modules to load, while <cite>shell_env</cite> allows the user
to specify or to modify the values of the environment variables.</p>
<p>The <cite>policy</cite> section governs the automatic parallelization of the run: in this case abipy will use
the <cite>autoparal</cite> features of abinit to determine an optimal configuration with <strong>maximum</strong> <cite>max_ncpus</cite> MPI nodes.
Setting <cite>autoparal</cite> to 0 disables the automatic parallelization. <strong>Other values of autoparal are not supported</strong>.</p>
<p>In some cases, you may want to enforce some constraint on the &#8220;optimal&#8221; configuration.
For example, you may want to select only those configurations whose parallel efficiency is greater than 0.7
and whose number of MPI nodes is divisible by 4.
One can easily enforce this constraint via the <cite>condition</cite> dictionary whose syntax is similar to the one used in <cite>mongodb</cite></p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">policy</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">autoparal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="l l-Scalar l-Scalar-Plain">max_ncpus</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span><span class="nv">$and</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span> <span class="p p-Indicator">{</span><span class="s">&quot;efficiency&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span><span class="nv">$gt</span><span class="p p-Indicator">:</span> <span class="nv">0.7</span><span class="p p-Indicator">}},</span> <span class="p p-Indicator">{</span><span class="s">&quot;tot_ncpus&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span><span class="nv">$divisible</span><span class="p p-Indicator">:</span> <span class="nv">4</span><span class="p p-Indicator">}}</span> <span class="p p-Indicator">]}</span>
</pre></div>
</div>
<p>The parallel efficiency is defined as $epsilon = dfrac{T_1}{T_N * N}$ where $N$ is the number
of MPI processes and $T_j$ is the wall time needed to complete the calculation with $j$ MPI processes.
For a perfect scaling implementation $epsilon$ is equal to one.
The parallel speedup with N processors is given by $S = T_N / T_1$.
Note that <cite>autoparal = 1</cite> will automatically change your <cite>job.sh</cite> script as well as the input file
so that we can run the job in parallel with the optimal configuration required by the user.
For example, you can use <cite>paral_kgb</cite> in GS calculations and <cite>abipy</cite> will automatically set the values
of <cite>npband</cite>, <cite>npfft</cite>, <cite>npkpt</cite> ... for you!
Note that if no configuration fulfills the given condition, abipy will use the optimal configuration
that leads to the highest parallel speedup (not necessarily the most efficient one).</p>
<p>Use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">FLOWDIR</span> <span class="n">cancel</span>
</pre></div>
</div>
<p>to cancel all tasks that have been submitted to the resource manager (the script asks for confirmation).
AbiPy detects if there&#8217;s a scheduler attached to the flow and it will also kill the scheduler</p>
<p>In the previous sections, we have discussed how to define, build and run a <cite>Flow</cite>, but there is a very
important point that we haven&#8217;t discussed yet.
It should be stressed, indeed, that <cite>AbiPy</cite> is only driving and monitoring the <cite>Flow</cite> while the actual calculation
is delegated to ABINIT (a Fortran program that is usually executed in parallel on multiple CPUs that communicate
via the network by means of the MPI protocol).
Besides CPUs and memory must be reserved in advance by sending a request to the resource manager
installed on the clusters (SLURM, PBS, etc)</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">nohup abirun.py FLOWDIR scheduler 2&gt; sched.log</p>
</div>
<p>One can put this configuration file either in the configuration directory <cite>$HOME/.abinit/abipy</cite>
or in the current working directory (the latter has precedence over the global configuration
file located in <cite>$HOME/.abinit/abipy</cite>).</p>
<p>because it&#8217;s possible to run the scheduler in the background with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">nohup</span> <span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">FLOWDIR</span> <span class="n">scheduler</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">sched</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>This shell command redirects the stdout/stderr of <cite>abirun.py</cite> to <cite>sched.log</cite>
and kill the active session without killing the scheduler thanks to the <cite>nohup</cite> unix command.
In this case, the PID gives as a handle that can be used to check whether the scheduler
is still running or kill it when we login again.</p>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>There are two other <cite>abirun</cite> commands that are very handy, especially if something goes wrong:</p>
<p>Use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">FLOWDIR</span> <span class="n">events</span>
</pre></div>
</div>
<p>to print the events (Abinit Warnings/Errors/Comments) found in the log files and:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">FLOWDIR</span> <span class="n">debug</span>
</pre></div>
</div>
<p>to analyze error files and log files for possible error messages.</p>
<p>To get information on the Abinit build, use</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ abirun.py abibuild --verbose
Traceback (most recent call last):
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/bin/abirun.py&quot;, line 4, in &lt;module&gt;
    __import__(&#39;pkg_resources&#39;).require(&#39;abipy==0.1.0&#39;)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2958, in &lt;module&gt;
    @_call_aside
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2944, in _call_aside
    f(*args, **kwargs)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 2971, in _initialize_master_working_set
    working_set = WorkingSet._build_master()
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 635, in _build_master
    ws.require(__requires__)
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 943, in require
    needed = self.resolve(parse_requirements(requirements))
  File &quot;/Users/gmatteo/anaconda/envs/venv2.7/lib/python2.7/site-packages/pkg_resources/__init__.py&quot;, line 829, in resolve
    raise DistributionNotFound(req, requirers)
pkg_resources.DistributionNotFound: The &#39;abipy==0.1.0&#39; distribution was not found and is required by the application
</pre></div>
</div>
<p>while:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">abirun</span><span class="o">.</span><span class="n">py</span> <span class="n">flow_si_ebands</span> <span class="n">handlers</span>
</pre></div>
</div>
<p>show the so-called events handlers that have been installed in the flow
(an event handler is an action that will be executed in response of a particular event</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> abirun.py flow_si_ebands handlers --verbose

<span class="go">List of event handlers installed:</span>
<span class="go">event name = !DilatmxError</span>
<span class="go">event documentation:</span>

<span class="go">    This Error occurs in variable cell calculations when the increase in the</span>
<span class="go">    unit cell volume is too large.</span>

<span class="go">handler documentation:</span>

<span class="go">    Handle DilatmxError. Abinit produces a netcdf file with the last structure before aborting</span>
<span class="go">    The handler changes the structure in the input with the last configuration and modify the value of dilatmx.</span>

<span class="go">event name = !TolSymError</span>
<span class="go">event documentation:</span>

<span class="go">    Class of errors raised by Abinit when it cannot detect the symmetries of the system.</span>
<span class="go">    The handler assumes the structure makes sense and the error is just due to numerical inaccuracies.</span>
<span class="go">    We increase the value of tolsym in the input file (default 1-8) so that Abinit can find the space group</span>
<span class="go">    and re-symmetrize the input structure.</span>

<span class="go">handler documentation:</span>

<span class="go">    Increase the value of tolsym in the input file.</span>

<span class="go">event name = !MemanaError</span>
<span class="go">event documentation:</span>

<span class="go">    Class of errors raised by the memory analyzer.</span>
<span class="go">    (the section that estimates the memory requirements from the input parameters).</span>

<span class="go">handler documentation:</span>

<span class="go">    Set mem_test to 0 to bypass the memory check.</span>

<span class="go">event name = !MemoryError</span>
<span class="go">event documentation:</span>

<span class="go">    This error occurs when a checked allocation fails in Abinit</span>
<span class="go">    The only way to go is to increase memory</span>

<span class="go">handler documentation:</span>

<span class="go">    Handle MemoryError. Increase the resources requirements</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="whats_new.html" class="btn btn-neutral float-right" title="What’s new in abipy" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="analyzing_results.html" class="btn btn-neutral" title="abiopen" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, The ABINIT group.
      Last updated on Mar 07, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>